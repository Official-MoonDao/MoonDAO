LavaPack.loadBundle([[229,{"../../../../shared/constants/app":5244,"../../../../shared/constants/gas":5252,"../../../../shared/constants/metametrics":5259,"../../../../shared/constants/transaction":5279,"../../../../shared/lib/confirmation.utils":5291,"../../../../shared/lib/transactions-controller-utils":5344,"../../../../shared/modules/Numeric":5349,"../../../../shared/modules/conversion.utils":5354,"../../../../shared/modules/gas.utils":5359,"../../../../shared/modules/metametrics":5362,"../../../../shared/modules/transaction.utils":5377,"../../../../ui/helpers/utils/metrics":6497,"../snap-keyring/metrics":205,"../util":237,"@metamask/transaction-controller":2587,"@metamask/utils":2632,"bignumber.js":3481,"ethereumjs-util":3849},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.handleTransactionSubmitted=s.handleTransactionRejected=s.handleTransactionFailed=s.handleTransactionDropped=s.handleTransactionConfirmed=s.handleTransactionApproved=s.handleTransactionAdded=s.handlePostTransactionBalanceUpdate=s.createTransactionEventFragmentWithTxId=s.METRICS_STATUS_FAILED=void 0;var n=t("bignumber.js"),a=t("ethereumjs-util"),i=t("@metamask/transaction-controller"),r=t("@metamask/utils"),o=t("../../../../shared/constants/app"),c=t("../../../../shared/constants/gas"),l=t("../../../../shared/constants/metametrics"),u=t("../../../../shared/constants/transaction"),d=t("../../../../shared/lib/transactions-controller-utils"),h=t("../../../../shared/modules/conversion.utils"),p=t("../../../../shared/modules/metametrics"),m=t("../../../../shared/modules/transaction.utils"),f=t("../../../../ui/helpers/utils/metrics"),g=t("../snap-keyring/metrics"),y=t("../../../../shared/lib/confirmation.utils"),S=t("../../../../shared/modules/gas.utils"),v=t("../../../../shared/modules/Numeric"),w=t("../util");const _=(0,r.createProjectLogger)("transaction-metrics"),b=s.METRICS_STATUS_FAILED="failed on-chain",E=[i.TransactionType.bridge,i.TransactionType.bridgeApproval,i.TransactionType.contractInteraction,i.TransactionType.tokenMethodApprove,i.TransactionType.tokenMethodIncreaseAllowance,i.TransactionType.tokenMethodSafeTransferFrom,i.TransactionType.tokenMethodSetApprovalForAll,i.TransactionType.tokenMethodTransfer,i.TransactionType.tokenMethodTransferFrom,i.TransactionType.swap,i.TransactionType.swapAndSend,i.TransactionType.swapApproval];var T=function(t){return t.swap="mm_swap",t.bridge="mm_bridge",t}(T||{});s.handleTransactionAdded=async(t,e)=>{if(!e.transactionMeta)return;const{properties:s,sensitiveProperties:n}=await A({transactionEventPayload:e,transactionMetricsRequest:t});k({eventName:u.TransactionMetaMetricsEvent.added,transactionEventPayload:e,transactionMetricsRequest:t,payload:{properties:s,sensitiveProperties:n}})};s.handleTransactionApproved=async(t,e)=>{e.transactionMeta&&await P({eventName:u.TransactionMetaMetricsEvent.approved,transactionEventPayload:e,transactionMetricsRequest:t})};s.handleTransactionFailed=async(t,e)=>{if(!e.transactionMeta)return;const s={};e.error&&(s.error=e.error),await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:s,transactionEventPayload:e,transactionMetricsRequest:t})};s.handleTransactionConfirmed=async(t,e)=>{if(0===Object.keys(e).length)return;const s={},n={...e},{txReceipt:a}=n;s.gas_used=null==a?void 0:a.gasUsed,s.block_number=(null==a?void 0:a.blockNumber)&&(0,h.hexToDecimal)(a.blockNumber);const{submittedTime:i,blockTimestamp:r}=n;i&&(s.completion_time=function(t){return Math.round((Date.now()-t)/1e3).toString()}(i)),i&&r&&(s.completion_time_onchain=function(t,e){const s=2,n=Number((0,h.hexToDecimal)(e))-t/1e3;return(Math.round(n*10**s)/10**s).toString()}(i,r)),"0x0"===(null==a?void 0:a.status)&&(s.status=b),await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:s,transactionEventPayload:{actionId:n.actionId,transactionMeta:n},transactionMetricsRequest:t})};s.handleTransactionDropped=async(t,e)=>{if(!e.transactionMeta)return;await P({eventName:u.TransactionMetaMetricsEvent.finalized,extraParams:{dropped:!0},transactionEventPayload:e,transactionMetricsRequest:t})};s.handleTransactionRejected=async(t,e)=>{e.transactionMeta&&await P({eventName:u.TransactionMetaMetricsEvent.rejected,transactionEventPayload:e,transactionMetricsRequest:t})};s.handleTransactionSubmitted=async(t,e)=>{if(!e.transactionMeta)return;const{properties:s,sensitiveProperties:n}=await A({transactionEventPayload:e,transactionMetricsRequest:t});k({eventName:u.TransactionMetaMetricsEvent.submitted,transactionEventPayload:e,transactionMetricsRequest:t,payload:{properties:s,sensitiveProperties:n}})};s.createTransactionEventFragmentWithTxId=async(t,{transactionId:e,actionId:s})=>{const n={...t.getTransaction(e),actionId:s},{properties:a,sensitiveProperties:i}=await A({transactionEventPayload:{transactionMeta:n},transactionMetricsRequest:t});k({eventName:u.TransactionMetaMetricsEvent.approved,transactionEventPayload:{actionId:n.actionId,transactionMeta:n},transactionMetricsRequest:t,payload:{properties:a,sensitiveProperties:i}})};function k({eventName:t,transactionEventPayload:{transactionMeta:e,actionId:s},transactionMetricsRequest:n,payload:a}){if(function(t,e,s){const n=M(e,s.id);return void 0!==t(n)}(n.getEventFragmentById,t,e)&&t!==u.TransactionMetaMetricsEvent.submitted)return;const i=M(t,e.id);switch(t){case u.TransactionMetaMetricsEvent.added:n.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,initialEvent:u.TransactionMetaMetricsEvent.added,successEvent:u.TransactionMetaMetricsEvent.approved,failureEvent:u.TransactionMetaMetricsEvent.rejected,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:s,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.rejected:n.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,successEvent:u.TransactionMetaMetricsEvent.approved,failureEvent:u.TransactionMetaMetricsEvent.rejected,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:s,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.submitted:n.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,initialEvent:u.TransactionMetaMetricsEvent.submitted,successEvent:u.TransactionMetaMetricsEvent.finalized,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:s,uniqueIdentifier:i,persist:!0});break;case u.TransactionMetaMetricsEvent.finalized:n.createEventFragment({category:l.MetaMetricsEventCategory.Transactions,successEvent:u.TransactionMetaMetricsEvent.finalized,properties:a.properties,sensitiveProperties:a.sensitiveProperties,actionId:s,uniqueIdentifier:i,persist:!0})}}async function P({eventName:t,transactionEventPayload:e,transactionMetricsRequest:s,extraParams:n={}}){const{properties:a,sensitiveProperties:i}=await A({transactionEventPayload:e,transactionMetricsRequest:s,extraParams:n});k({eventName:t,transactionEventPayload:e,transactionMetricsRequest:s,payload:{properties:a,sensitiveProperties:i}}),function({eventName:t,transactionEventPayload:{transactionMeta:e},transactionMetricsRequest:s,payload:n}){const a=M(t,e.id);switch(t){case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.rejected:case u.TransactionMetaMetricsEvent.finalized:s.updateEventFragment(a,{properties:n.properties,sensitiveProperties:n.sensitiveProperties})}}({eventName:t,transactionEventPayload:e,transactionMetricsRequest:s,payload:{properties:a,sensitiveProperties:i}}),function({eventName:t,transactionMetricsRequest:e,transactionEventPayload:{transactionMeta:s}}){const n=M(t,s.id);switch(t){case u.TransactionMetaMetricsEvent.approved:case u.TransactionMetaMetricsEvent.finalized:e.finalizeEventFragment(n);break;case u.TransactionMetaMetricsEvent.rejected:e.finalizeEventFragment(n,{abandoned:!0})}}({eventName:t,transactionEventPayload:e,transactionMetricsRequest:s})}function M(t,e){return`transaction-${t===u.TransactionMetaMetricsEvent.finalized||t===u.TransactionMetaMetricsEvent.submitted?"submitted":"added"}-${e}`}async function A({transactionEventPayload:{transactionMeta:t},transactionMetricsRequest:e,extraParams:s={}}){var b;const{type:T,time:k,status:P,chainId:M,origin:A,txParams:{gasPrice:C,gas:R,maxFeePerGas:O,maxPriorityFeePerGas:j,estimateSuggested:x,estimateUsed:N},defaultGasEstimates:L,originalType:D,replacedById:H,customTokenAmount:$,dappProposedTokenAmount:F,currentTokenBalance:U,originalApprovalAmount:V,finalApprovalAmount:q,securityProviderResponse:B,simulationFails:W,id:z,userFeeLevel:G}=t,Y=A===o.ORIGIN_METAMASK?"user":"dapp",K="dappSuggested"===G?"dapp_proposed":G,{assetType:J,tokenStandard:Z}=await(0,m.determineTransactionAssetType)(t,e.provider,e.getTokenStandardAndDetails);let Q;if(t.txParams.data){const s=await e.getMethodData(t.txParams.data);Q=null==s?void 0:s.name}const X={};if((0,m.isEIP1559Transaction)(t)?(X.max_fee_per_gas=O,X.max_priority_fee_per_gas=j):(X.gas_price=C,X.default_estimate=l.MetaMetricsEventTransactionEstimateType.DefaultEstimate),L){var tt,et;const{estimateType:s}=L;if(s){var st,nt;X.default_estimate=s===c.PriorityLevels.dAppSuggested?l.MetaMetricsEventTransactionEstimateType.DappProposed:s;let n=null===(st=t.defaultGasEstimates)||void 0===st?void 0:st.maxFeePerGas,a=null===(nt=t.defaultGasEstimates)||void 0===nt?void 0:nt.maxPriorityFeePerGas;if([c.GasRecommendations.low,c.GasRecommendations.medium,c.GasRecommendations.high].includes(s)){var at,it;const{gasFeeEstimates:t}=await e.getEIP1559GasFeeEstimates();var rt,ot;if(null!=t&&null!==(at=t[s])&&void 0!==at&&at.suggestedMaxFeePerGas)n=null===(rt=t[s])||void 0===rt?void 0:rt.suggestedMaxFeePerGas,X.default_max_fee_per_gas=n;if(null!=t&&null!==(it=t[s])&&void 0!==it&&it.suggestedMaxPriorityFeePerGas)a=null===(ot=t[s])||void 0===ot?void 0:ot.suggestedMaxPriorityFeePerGas,X.default_max_priority_fee_per_gas=a}}null!==(tt=t.defaultGasEstimates)&&void 0!==tt&&tt.gas&&(X.default_gas=t.defaultGasEstimates.gas),null!==(et=t.defaultGasEstimates)&&void 0!==et&&et.gasPrice&&(X.default_gas_price=t.defaultGasEstimates.gasPrice)}x&&(X.estimate_suggested=x),N&&(X.estimate_used=N),null!=s&&s.gas_used&&(X.gas_used=s.gas_used);const ct=function(t){const e={};for(const s in t)(0,a.isHexString)(t[s])?e[s]=(0,h.hexWEIToDecGWEI)(t[s]):e[s]=t[s];return e}(X);let lt="0";t.txParams.maxFeePerGas&&(lt="2");const ut="Approve";let dt,ht,pt,mt,ft,gt;const{transactionType:yt,isContractInteraction:St}=function(t,e){const s=t&&E.includes(t);if([i.TransactionType.swapAndSend,i.TransactionType.cancel,i.TransactionType.deployContract,i.TransactionType.gasPayment,i.TransactionType.batch].includes(t))return{transactionType:t,isContractInteraction:s};if(t===i.TransactionType.retry&&e)return{transactionType:e,isContractInteraction:s};if(s){const e=I(t);return e?{transactionType:e,isContractInteraction:!0}:{transactionType:i.TransactionType.contractInteraction,isContractInteraction:!0}}return{transactionType:i.TransactionType.simpleSend,isContractInteraction:!1}}(T,D);var vt,wt;St&&(ht=Q,ft=null===(vt=t.txParams)||void 0===vt?void 0:vt.to,gt=null===(wt=t.txParams)||void 0===wt||null===(wt=wt.data)||void 0===wt?void 0:wt.slice(0,10),ht===ut&&Z===u.TokenStandard.ERC20&&("0"===F||"0"===$?dt=u.TransactionApprovalAmountType.revoke:$&&$!==F?dt=u.TransactionApprovalAmountType.custom:F&&(dt=u.TransactionApprovalAmountType.dappProposed),pt=function(t,e,s){if(t===u.TransactionApprovalAmountType.custom&&e&&s)return`${new n.BigNumber(e,10).div(s,10).times(100).round(2)}`;return null}(dt,V,q),mt=function(t,e,s){if((t===u.TransactionApprovalAmountType.custom||t===u.TransactionApprovalAmountType.dappProposed)&&e&&s)return`${new n.BigNumber(e,16).div(s,10).times(100).round(2)}`;return null}(dt,F,U)));const _t=e.getTransaction(H),bt={RETRY:i.TransactionType.retry,CANCEL:i.TransactionType.cancel,SAME_NONCE:"other"};let Et;null!=s&&s.dropped&&(Et=bt.SAME_NONCE,(null==_t?void 0:_t.type)===i.TransactionType.cancel?Et=bt.CANCEL:(null==_t?void 0:_t.type)===i.TransactionType.retry&&(Et=bt.RETRY));const Tt=[];let kt=null;1===(null==B?void 0:B.flagAsDangerous)?Tt.push(l.MetaMetricsEventUiCustomization.FlaggedAsMalicious):2===(null==B?void 0:B.flagAsDangerous)&&Tt.push(l.MetaMetricsEventUiCustomization.FlaggedAsSafetyUnknown);const Pt=(0,f.getBlockaidMetricsProps)(t);(null==Pt||null===(b=Pt.ui_customizations)||void 0===b?void 0:b.length)>0&&Tt.push(...Pt.ui_customizations),W&&Tt.push(l.MetaMetricsEventUiCustomization.GasEstimationFailed);(0,y.shouldUseRedesignForTransactions)({transactionMetadataType:t.type})&&(Tt.push(l.MetaMetricsEventUiCustomization.RedesignedConfirmation),kt=e.getIsConfirmationAdvancedDetailsOpen());const Mt=(0,p.getSmartTransactionMetricsProperties)(e,t),At=(0,f.getSwapAndSendMetricsProps)(t),It={hd_entropy_index:e.getHDEntropyIndex()};let Ct;try{Ct=await e.getAccountType(e.getSelectedAddress())}catch(t){Ct="error",_("Error getting account type for transaction metrics:",t)}let Rt={chain_id:M,referrer:A,source:Y,status:P,network:`${parseInt(M,16)}`,eip_1559_version:lt,gas_edit_type:"none",gas_edit_attempted:"none",gas_estimation_failed:Boolean(W),account_type:Ct,device_model:await e.getDeviceModel(e.getSelectedAddress()),asset_type:J,token_standard:Z,transaction_type:yt,transaction_speed_up:T===i.TransactionType.retry,transaction_internal_id:z,gas_fee_selected:K,...Pt,ui_customizations:Tt.length>0?Tt:null,transaction_advanced_view:kt,transaction_contract_method:ht?[ht]:[],...Mt,...At,...It};const Ot=await(0,g.getSnapAndHardwareInfoForMetrics)(e.getAccountType,e.getDeviceModel,e.getHardwareTypeForMetric,e.snapAndHardwareMessenger);var jt,xt;(Object.assign(Rt,Ot),ht===ut||I(T))&&(Rt={...Rt,simulation_receiving_assets_total_value:Rt.simulation_receiving_assets_total_value??(null==t||null===(jt=t.assetsFiatValues)||void 0===jt?void 0:jt.receiving),simulation_sending_assets_total_value:Rt.simulation_sending_assets_total_value??(null==t||null===(xt=t.assetsFiatValues)||void 0===xt?void 0:xt.sending),transaction_approval_amount_type:dt});let Nt={transaction_envelope_type:(0,m.isEIP1559Transaction)(t)?d.TRANSACTION_ENVELOPE_TYPE_NAMES.FEE_MARKET:d.TRANSACTION_ENVELOPE_TYPE_NAMES.LEGACY,first_seen:k,gas_limit:R,transaction_replaced:Et,transaction_contract_address:ft?[ft]:[],transaction_contract_method_4byte:gt,...s,...ct};if(ht===ut&&(Nt={...Nt,transaction_approval_amount_vs_balance_ratio:mt,transaction_approval_amount_vs_proposed_ratio:pt}),await async function(t,e,s,n){const a=origin&&origin!==o.ORIGIN_METAMASK,{delegationAddress:r,nestedTransactions:c,txParams:l}=t,{authorizationList:d}=l,h=Boolean(null==c?void 0:c.length),p=Boolean(null==d?void 0:d.length);a&&(s.api_method=h?o.MESSAGE_TYPE.WALLET_SEND_CALLS:o.MESSAGE_TYPE.ETH_SEND_TRANSACTION);h&&(s.batch_transaction_count=null==c?void 0:c.length,s.batch_transaction_method="eip7702",s.transaction_contract_method=await async function(t,e){const s=t.filter(t=>E.includes(t.type)&&t.data).map(t=>t.data),n=await Promise.all(s.map(t=>e(t)));return n.map(t=>null==t?void 0:t.name).filter(t=>null==t?void 0:t.length)}(c??[],e),n.transaction_contract_address=null==c?void 0:c.filter(t=>{var e;return E.includes(t.type)&&(null===(e=t.to)||void 0===e?void 0:e.length)}).map(t=>t.to));if(t.status===i.TransactionStatus.rejected){const{error:e}=t;s.eip7702_upgrade_rejection=p&&e.code===u.EIP5792ErrorCode.RejectedUpgrade}s.eip7702_upgrade_transaction=p,n.account_eip7702_upgraded=r}(t,e.getMethodData,Rt,Nt),function(t,e,s,n){var a;const{gasFeeTokens:i,selectedGasFeeToken:o}=t;e.gas_payment_tokens_available=null==i?void 0:i.map(t=>t.symbol),e.gas_paid_with=null==i||null===(a=i.find(t=>t.tokenAddress.toLowerCase()===(null==o?void 0:o.toLowerCase())))||void 0===a?void 0:a.symbol,(null==o?void 0:o.toLowerCase())===u.NATIVE_TOKEN_ADDRESS&&(e.gas_paid_with="pre-funded_ETH");e.gas_insufficient_native_asset=function(t,e){const{chainId:s,txParams:n}=t,{from:a,gas:i,gasPrice:o,maxFeePerGas:c,value:l}=n,u=e(a,s),d=(0,S.getMaximumGasTotalInHexWei)({gasLimit:i,gasPrice:o,maxFeePerGas:c}),p=(0,r.add0x)((0,h.addHexes)(d,l??"0x0"));return new v.Numeric(p,16).greaterThan(new v.Numeric(u,16))}(t,n)}(t,Rt,0,e.getAccountBalance),P===i.TransactionStatus.submitted||P===i.TransactionStatus.confirmed){const s=e.getNetworkRpcUrl(t.chainId),n=(0,w.extractRpcDomain)(s);Rt.rpc_domain=n}return{properties:Rt,sensitiveProperties:Nt}}function I(t){return t===i.TransactionType.swap?T.swap:t===i.TransactionType.bridge?T.bridge:null}s.handlePostTransactionBalanceUpdate=async({getParticipateInMetrics:t,trackEvent:e,getHDEntropyIndex:s},{transactionMeta:a,approvalTransactionMeta:i})=>{var r;if(t()&&a.swapMetaData)if("0x0"===(null===(r=a.txReceipt)||void 0===r?void 0:r.status))e({event:l.MetaMetricsEventName.SwapFailed,category:l.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...a.swapMetaData},properties:{hd_entropy_index:s()}});else{var o;const t=(0,d.getSwapsTokensReceivedFromTxMeta)(a.destinationTokenSymbol,a,a.destinationTokenAddress,a.txParams.from,a.destinationTokenDecimals,i,a.chainId),r=t?`${new n.BigNumber(t,10).div(a.swapMetaData.token_to_amount,10).times(100).round(2)}%`:null,c=null!==(o=a.txReceipt)&&void 0!==o&&o.gasUsed&&a.swapMetaData.estimated_gas?`${new n.BigNumber(a.txReceipt.gasUsed,16).div(a.swapMetaData.estimated_gas,10).times(100).round(2)}%`:null,u=function(t,e){var s,a;let i="0x0";null!=e&&e.txReceipt&&(i=(0,d.calcGasTotal)(e.txReceipt.gasUsed,e.txReceipt.effectiveGasPrice));const r=(0,d.calcGasTotal)(null===(s=t.txReceipt)||void 0===s?void 0:s.gasUsed,null===(a=t.txReceipt)||void 0===a?void 0:a.effectiveGasPrice),o=new n.BigNumber(r,16).plus(i,16).toString(16);return{approvalGasCostInEth:Number((0,h.hexWEIToDecETH)(i)),tradeGasCostInEth:Number((0,h.hexWEIToDecETH)(r)),tradeAndApprovalGasCostInEth:Number((0,h.hexWEIToDecETH)(o))}}(a,i);e({event:l.MetaMetricsEventName.SwapCompleted,category:l.MetaMetricsEventCategory.Swaps,sensitiveProperties:{...a.swapMetaData,token_to_amount_received:t,quote_vs_executionRatio:r,estimated_vs_used_gasRatio:c,approval_gas_cost_in_eth:u.approvalGasCostInEth,trade_gas_cost_in_eth:u.tradeGasCostInEth,trade_and_approval_gas_cost_in_eth:u.tradeAndApprovalGasCostInEth,token_to_amount:a.swapMetaData.token_to_amount.toString(10)},properties:{hd_entropy_index:s()}})}}}}},{package:"$root$",file:"app/scripts/lib/transaction/metrics.ts"}],[2290,{"./MultichainRouter.cjs":2289},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./MultichainRouter.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/multichain/index.cjs"}],[2291,{"../logging.cjs":2288,"../snaps/Timer.cjs":2300,"../utils.cjs":2312,"@metamask/json-rpc-engine":1863,"@metamask/json-rpc-middleware-stream":1867,"@metamask/object-multiplex":2078,"@metamask/rpc-errors":2224,"@metamask/snaps-utils":2516,"@metamask/utils":2632,nanoid:4546,"readable-stream":4805},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){a(t,e),e.set(t,s)}function a(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function r(t,e){return t.get(c(t,e))}function o(t,e,s){return t.set(c(t,e),s),s}function c(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}var l=function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0}),s.setupMultiplex=s.AbstractExecutionService=void 0;const u=t("@metamask/json-rpc-engine"),d=t("@metamask/json-rpc-middleware-stream"),h=l(t("@metamask/object-multiplex")),p=t("@metamask/rpc-errors"),m=t("@metamask/snaps-utils"),f=t("@metamask/utils"),g=t("nanoid"),y=t("readable-stream"),S=t("../logging.cjs"),v=t("../snaps/Timer.cjs"),w=t("../utils.cjs"),_="ExecutionService";var b=new WeakMap,E=new WeakMap,T=new WeakMap,k=new WeakMap,P=new WeakMap,M=new WeakMap,A=new WeakMap,I=new WeakMap,C=new WeakSet;function R(){r(k,this).registerActionHandler(`${_}:handleRpcRequest`,async(t,e)=>this.handleRpcRequest(t,e)),r(k,this).registerActionHandler(`${_}:executeSnap`,async t=>this.executeSnap(t)),r(k,this).registerActionHandler(`${_}:terminateSnap`,async t=>this.terminateSnap(t)),r(k,this).registerActionHandler(`${_}:terminateAllSnaps`,async()=>this.terminateAllSnaps())}async function O(t,e){const{streams:s,worker:n}=await c(C,this,j).call(this,t,e),a=new u.JsonRpcEngine,i=(0,d.createStreamMiddleware)();(0,y.pipeline)(i.stream,s.command,i.stream,t=>{var e;!t||null!==(e=t.message)&&void 0!==e&&e.match("Premature close")||(0,m.logError)("Command stream failure.",t)}),a.push(i.middleware);const o={id:t,streams:s,rpcEngine:a,worker:n};return r(b,this).set(t,o),o}async function j(t,e){const s=await(0,w.withTimeout)(this.initEnvStream(t),e);if(s===w.hasTimedOut){this.terminateJob({id:t});if("created"===r(E,this).get(t))throw new Error(`The executor for "${t}" couldn't start initialization. The offscreen document may not exist.`);throw new Error(`The executor for "${t}" failed to initialize. The iframe/webview/worker failed to load.`)}const{worker:n,stream:a}=s,i=N(a,`Snap: "${t}"`),o=i.createStream(m.SNAP_STREAM_NAMES.COMMAND),c=e=>{(0,f.hasProperty)(e,"id")||("OutboundRequest"===e.method?r(k,this).publish("ExecutionService:outboundRequest",t):"OutboundResponse"===e.method?r(k,this).publish("ExecutionService:outboundResponse",t):"UnhandledError"===e.method?(r(k,this).publish("ExecutionService:unhandledError",t,e.params.error),o.removeListener("data",c)):(0,m.logError)(new Error(`Received unexpected command stream notification "${e.method}".`)))};o.on("data",c);const l=i.createStream(m.SNAP_STREAM_NAMES.JSON_RPC);return{streams:{command:o,rpc:l,_connection:a},worker:n}}async function x(t,e){const s=r(b,this).get(t);if(!s)throw new Error(`"${t}" is not currently running.`);(0,S.log)("Parent: Sending Command",e);const n=await s.rpcEngine.handle(e);if((0,f.isJsonRpcFailure)(n))throw new p.JsonRpcError(n.error.code,n.error.message,n.error.data);return n.result}function N(t,e){const s=new h.default;return(0,y.pipeline)(t,s,t,t=>{var s;!t||null!==(s=t.message)&&void 0!==s&&s.match("Premature close")||(0,m.logError)(`"${e}" stream failure.`,t)}),s}s.AbstractExecutionService=class{constructor({setupSnapProvider:t,messenger:e,initTimeout:s=(0,f.inMilliseconds)(60,f.Duration.Second),pingTimeout:r=(0,f.inMilliseconds)(2,f.Duration.Second),terminationTimeout:l=(0,f.inMilliseconds)(1,f.Duration.Second),usePing:u=!0}){var d,h;a(d=this,h=C),h.add(d),i(this,"name",_),i(this,"state",null),n(this,b,void 0),n(this,E,void 0),n(this,T,void 0),n(this,k,void 0),n(this,P,void 0),n(this,M,void 0),n(this,A,void 0),n(this,I,void 0),o(b,this,new Map),o(E,this,new Map),o(T,this,t),o(k,this,e),o(P,this,s),o(M,this,r),o(A,this,l),o(I,this,u),c(C,this,R).call(this)}async terminateSnap(t){const e=r(b,this).get(t);if(e){try{const e=await(0,w.withTimeout)(c(C,this,x).call(this,t,{jsonrpc:"2.0",method:"terminate",params:[],id:(0,g.nanoid)()}),r(A,this));e!==w.hasTimedOut&&"OK"===e||(0,m.logError)(`Snap "${t}" failed to terminate gracefully.`,e)}catch{}Object.values(e.streams).forEach(t=>{try{t.destroyed||t.destroy()}catch(t){(0,m.logError)("Error while destroying stream",t)}}),this.terminateJob(e),r(b,this).delete(t),r(E,this).delete(t),(0,S.log)(`Snap "${t}" terminated.`)}}setSnapStatus(t,e){r(E,this).set(t,e)}async terminateAllSnaps(){await Promise.all([...r(b,this).keys()].map(async t=>this.terminateSnap(t)))}async executeSnap({snapId:t,sourceCode:e,endowments:s}){if(r(b,this).has(t))throw new Error(`"${t}" is already running.`);this.setSnapStatus(t,"created");const n=new v.Timer(r(P,this)),a=await c(C,this,O).call(this,t,n);if(r(I,this)){if(await(0,w.withTimeout)(c(C,this,x).call(this,a.id,{jsonrpc:"2.0",method:"ping",id:(0,g.nanoid)()}),r(M,this))===w.hasTimedOut)throw new Error(`The executor for "${t}" was unreachable. The executor did not respond in time.`)}const i=a.streams.rpc;r(T,this).call(this,t,i);const o=Math.max(n.remaining,r(P,this)/2);this.setSnapStatus(t,"initialized");const l={jsonrpc:"2.0",method:"executeSnap",params:{snapId:t,sourceCode:e,endowments:s},id:(0,g.nanoid)()};(0,f.assertIsJsonRpcRequest)(l),this.setSnapStatus(t,"executing");const u=await(0,w.withTimeout)(c(C,this,x).call(this,a.id,l),o);if(u===w.hasTimedOut)throw new Error(`${t} failed to start.`);return"OK"===u&&this.setSnapStatus(t,"running"),u}async handleRpcRequest(t,e){const{handler:s,request:n,origin:a}=e;return await c(C,this,x).call(this,t,{id:(0,g.nanoid)(),jsonrpc:"2.0",method:"snapRpc",params:{origin:a,handler:s,request:n,target:t}})}},s.setupMultiplex=N}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/AbstractExecutionService.cjs"}],[2292,{"@metamask/post-message-stream":2111},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){a(t,e),e.set(t,s)}function a(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(t,e){return t.get(o(t,e))}function r(t,e,s){return t.set(o(t,e),s),s}function o(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.ProxyPostMessageStream=void 0;const c=t("@metamask/post-message-stream");var l=new WeakMap,u=new WeakMap,d=new WeakSet;class h extends c.BasePostMessageStream{constructor({stream:t,jobId:e}){var s,c;super(),a(s=this,c=d),c.add(s),n(this,l,void 0),n(this,u,void 0),r(l,this,t),r(u,this,e),i(l,this).on("data",o(d,this,p).bind(this))}_postMessage(t){i(l,this).write({jobId:i(u,this),data:t})}}function p(t){t.jobId===i(u,this)&&this.push(t.data)}s.ProxyPostMessageStream=h}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/ProxyPostMessageStream.cjs"}],[2293,{"../AbstractExecutionService.cjs":2291,"@metamask/post-message-stream":2111,"@metamask/snaps-utils":2516},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}Object.defineProperty(s,"__esModule",{value:!0}),s.IframeExecutionService=void 0;const a=t("@metamask/post-message-stream"),i=t("@metamask/snaps-utils"),r=t("../AbstractExecutionService.cjs");class o extends r.AbstractExecutionService{constructor({iframeUrl:t,messenger:e,setupSnapProvider:s,...a}){super({...a,messenger:e,setupSnapProvider:s}),n(this,"iframeUrl",void 0),this.iframeUrl=t}terminateJob(t){var e;null===(e=document.getElementById(t.id))||void 0===e||e.remove()}async initEnvStream(t){this.setSnapStatus(t,"initializing");const e=await(0,i.createWindow)({uri:this.iframeUrl.toString(),id:t});return{worker:e,stream:new a.WindowPostMessageStream({name:"parent",target:"child",targetWindow:e,targetOrigin:"*"})}}}s.IframeExecutionService=o}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/iframe/IframeExecutionService.cjs"}],[2294,{"./IframeExecutionService.cjs":2293},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./IframeExecutionService.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/iframe/index.cjs"}],[2295,{"./AbstractExecutionService.cjs":2291,"./ProxyPostMessageStream.cjs":2292,"./iframe/index.cjs":2294,"./offscreen/index.cjs":2297},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./AbstractExecutionService.cjs"),s),a(t("./ProxyPostMessageStream.cjs"),s),a(t("./iframe/index.cjs"),s),a(t("./offscreen/index.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/index.cjs"}],[2296,{"../proxy/ProxyExecutionService.cjs":2298,"@metamask/post-message-stream":2111},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.set(t,s)}function a(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.OffscreenExecutionService=void 0;const i=t("@metamask/post-message-stream"),r=t("../proxy/ProxyExecutionService.cjs");var o=new WeakMap;class c extends r.ProxyExecutionService{constructor({messenger:t,setupSnapProvider:e,offscreenPromise:s,...r}){var c,l,u;super({...r,messenger:t,setupSnapProvider:e,stream:new i.BrowserRuntimePostMessageStream({name:"parent",target:"child"})}),n(this,o,void 0),l=this,u=s,(c=o).set(a(c,l),u)}async initEnvStream(t){var e,s;return await(e=o,s=this,e.get(a(e,s))),await super.initEnvStream(t)}}s.OffscreenExecutionService=c}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/offscreen/OffscreenExecutionService.cjs"}],[2297,{"./OffscreenExecutionService.cjs":2296},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./OffscreenExecutionService.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/offscreen/index.cjs"}],[2298,{"../AbstractExecutionService.cjs":2291,"../ProxyPostMessageStream.cjs":2292,nanoid:4546},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.set(t,s)}function a(t,e){return t.get(i(t,e))}function i(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.ProxyExecutionService=void 0;const r=t("nanoid"),o=t("../AbstractExecutionService.cjs"),c=t("../ProxyPostMessageStream.cjs");var l=new WeakMap;class u extends o.AbstractExecutionService{constructor({stream:t,messenger:e,setupSnapProvider:s,...a}){var r,o,c;super({...a,messenger:e,setupSnapProvider:s,usePing:!1}),n(this,l,void 0),o=this,c=t,(r=l).set(i(r,o),c)}async terminateJob(t){a(l,this).write({jobId:t.id,data:{jsonrpc:"2.0",method:"terminateJob",id:(0,r.nanoid)()}})}async initEnvStream(t){this.setSnapStatus(t,"initializing");const e=new c.ProxyPostMessageStream({stream:a(l,this),jobId:t});return await new Promise(t=>{e.once("data",t),e.write({name:"command",data:{jsonrpc:"2.0",method:"ping",id:(0,r.nanoid)()}})}),{worker:t,stream:e}}}s.ProxyExecutionService=u}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/services/proxy/ProxyExecutionService.cjs"}],[2299,{"../fsm.cjs":2281,"../logging.cjs":2288,"../utils.cjs":2312,"./Timer.cjs":2300,"./constants.cjs":2301,"./location/index.cjs":2304,"./registry/index.cjs":2308,"./selectors.cjs":2311,"@metamask/base-controller":1140,"@metamask/permission-controller":2090,"@metamask/rpc-errors":2224,"@metamask/snaps-rpc-methods":2346,"@metamask/snaps-sdk":2402,"@metamask/snaps-utils":2516,"@metamask/utils":2632,"@xstate/fsm":3100,"async-mutex":3415,nanoid:4546,semver:5080},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function a(t,e,s){i(t,e),e.set(t,s)}function i(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function r(t,e){return t.get(c(t,e))}function o(t,e,s){return t.set(c(t,e),s),s}function c(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.SnapController=s.SNAP_APPROVAL_RESULT=s.SNAP_APPROVAL_UPDATE=s.SNAP_APPROVAL_INSTALL=s.controllerName=void 0;const l=t("@metamask/base-controller"),u=t("@metamask/permission-controller"),d=t("@metamask/rpc-errors"),h=t("@metamask/snaps-rpc-methods"),p=t("@metamask/snaps-sdk"),m=t("@metamask/snaps-utils"),f=t("@metamask/utils"),g=t("@xstate/fsm"),y=t("async-mutex"),S=t("nanoid"),v=t("semver"),w=t("./constants.cjs"),_=t("./location/index.cjs"),b=t("./registry/index.cjs"),E=t("./selectors.cjs"),T=t("./Timer.cjs"),k=t("../fsm.cjs"),P=t("../logging.cjs"),M=t("../utils.cjs");s.controllerName="SnapController",s.SNAP_APPROVAL_INSTALL="wallet_installSnap",s.SNAP_APPROVAL_UPDATE="wallet_updateSnap",s.SNAP_APPROVAL_RESULT="wallet_installSnapResult";const A=new Set(["initialPermissions","id","version","enabled","blocked"]),I={snaps:{},snapStates:{},unencryptedSnapStates:{}};function C(t){return Object.keys(t).reduce((e,s)=>(A.has(s)&&(e[s]=t[s]),e),{})}var R=new WeakMap,O=new WeakMap,j=new WeakMap,x=new WeakMap,N=new WeakMap,L=new WeakMap,D=new WeakMap,H=new WeakMap,$=new WeakMap,F=new WeakMap,U=new WeakMap,V=new WeakMap,q=new WeakMap,B=new WeakMap,W=new WeakMap,z=new WeakMap,G=new WeakMap,Y=new WeakMap,K=new WeakMap,J=new WeakMap,Z=new WeakSet,Q=new WeakMap;class X extends l.BaseController{constructor({closeAllConnections:t,messenger:e,state:l,dynamicPermissions:u=["eth_accounts"],environmentEndowmentPermissions:d=[],excludedPermissions:h={},idleTimeCheckInterval:g=(0,f.inMilliseconds)(5,f.Duration.Second),maxIdleTime:y=(0,f.inMilliseconds)(30,f.Duration.Second),maxRequestTime:S=(0,f.inMilliseconds)(60,f.Duration.Second),fetchFunction:v=globalThis.fetch.bind(undefined),featureFlags:b={},detectSnapLocation:E=_.detectSnapLocation,preinstalledSnaps:T=null,encryptor:k,getMnemonicSeed:P,getFeatureFlags:A=()=>({}),clientCryptography:C,trackEvent:X}){var at,it,rt;super({messenger:e,metadata:{snapStates:{persist:!0,anonymous:!1},unencryptedSnapStates:{persist:!0,anonymous:!1},snaps:{persist:t=>Object.values(t).filter(t=>t.status!==m.SnapStatus.Installing).map(t=>({...t,status:m.SnapStatus.Stopped})).reduce((t,e)=>(t[e.id]=e,t),{}),anonymous:!1}},name:s.controllerName,state:{...I,...l}}),i(it=this,rt=Z),rt.add(it),a(this,R,void 0),a(this,O,void 0),a(this,j,void 0),a(this,x,void 0),a(this,N,void 0),a(this,L,void 0),a(this,D,void 0),a(this,H,void 0),n(this,"maxRequestTime",void 0),a(this,$,void 0),a(this,F,void 0),a(this,U,void 0),a(this,V,void 0),a(this,q,void 0),a(this,B,void 0),a(this,W,void 0),a(this,z,void 0),a(this,G,void 0),a(this,Y,void 0),a(this,K,void 0),a(this,J,void 0),a(this,Q,(0,M.debouncePersistState)((t,e,s)=>{c(Z,this,zt).call(this,t).stateMutex.runExclusive(async()=>{const n=await c(Z,this,gt).call(this,t,e,s);return s?this.update(e=>{e.snapStates[t]=n}):this.update(e=>{e.unencryptedSnapStates[t]=n})}).catch(m.logError)},w.STATE_DEBOUNCE_TIMEOUT)),o(R,this,t),o(O,this,u),o(j,this,d),o(x,this,h),o(N,this,b),o(L,this,v),o(D,this,g),o(H,this,y),this.maxRequestTime=S,o(q,this,E),o($,this,k),o(F,this,P),o(U,this,A),o(V,this,C),o(Y,this,T),this._onUnhandledSnapError=this._onUnhandledSnapError.bind(this),this._onOutboundRequest=this._onOutboundRequest.bind(this),this._onOutboundResponse=this._onOutboundResponse.bind(this),o(W,this,new Map),o(B,this,new Map),o(K,this,X),c(Z,this,nt).call(this),this.messagingSystem.subscribe("ExecutionService:unhandledError",this._onUnhandledSnapError),this.messagingSystem.subscribe("ExecutionService:outboundRequest",this._onOutboundRequest),this.messagingSystem.subscribe("ExecutionService:outboundResponse",this._onOutboundResponse),this.messagingSystem.subscribe("SnapController:snapInstalled",({id:t},e)=>{c(Z,this,ee).call(this,e,t,m.HandlerType.OnInstall).catch(e=>{(0,m.logError)(`Error when calling \`onInstall\` lifecycle hook for snap "${t}": ${(0,p.getErrorMessage)(e)}`)})}),this.messagingSystem.subscribe("SnapController:snapUpdated",({id:t},e,s)=>{c(Z,this,ee).call(this,s,t,m.HandlerType.OnUpdate).catch(e=>{(0,m.logError)(`Error when calling \`onUpdate\` lifecycle hook for snap "${t}": ${(0,p.getErrorMessage)(e)}`)})}),this.messagingSystem.subscribe("KeyringController:lock",c(Z,this,se).bind(this)),c(Z,this,tt).call(this),c(Z,this,et).call(this),Object.values((null===(at=this.state)||void 0===at?void 0:at.snaps)??{}).forEach(t=>c(Z,this,Gt).call(this,t.id)),r(Y,this)&&c(Z,this,st).call(this,r(Y,this)),o(J,this,(0,M.throttleTracking)((t,e,s,n)=>{const a=this.messagingSystem.call("SnapsRegistry:getMetadata",t);r(K,this).call(this,{event:"Snap Export Used",category:"Snaps",properties:{snap_id:t,export:e,snap_category:null==a?void 0:a.category,success:s,origin:n}})}))}init(){c(Z,this,te).call(this,w.METAMASK_ORIGIN,m.HandlerType.OnStart)}async updateBlockedSnaps(){c(Z,this,ct).call(this),await this.messagingSystem.call("SnapsRegistry:update");const t=await this.messagingSystem.call("SnapsRegistry:get",Object.values(this.state.snaps).reduce((t,e)=>(t[e.id]={version:e.version,checksum:e.manifest.source.shasum},t),{}));await Promise.all(Object.entries(t).map(async([t,{status:e,reason:s}])=>e===b.SnapsRegistryStatus.Blocked?c(Z,this,at).call(this,t,s):c(Z,this,it).call(this,t)))}_onUnhandledSnapError(t,e){(0,m.logError)(`Unhandled error from "${t}":`,e),this.stopSnap(t,m.SnapStatusEvents.Crash).catch(t=>{(0,m.logError)(t)})}_onOutboundRequest(t){const e=c(Z,this,zt).call(this,t);e.pendingInboundRequests.filter(t=>"running"===t.timer.status).forEach(t=>t.timer.pause()),e.pendingOutboundRequests+=1}_onOutboundResponse(t){const e=c(Z,this,zt).call(this,t);e.pendingOutboundRequests-=1,0===e.pendingOutboundRequests&&e.pendingInboundRequests.filter(t=>"paused"===t.timer.status).forEach(t=>t.timer.resume())}async startSnap(t){c(Z,this,ct).call(this);const e=this.state.snaps[t];if(!e.enabled)throw new Error(`Snap "${t}" is disabled.`);await c(Z,this,kt).call(this,{snapId:t,sourceCode:e.sourceCode})}enableSnap(t){if(this.getExpect(t),this.state.snaps[t].blocked)throw new Error(`Snap "${t}" is blocked and cannot be enabled.`);this.update(e=>{e.snaps[t].enabled=!0}),this.messagingSystem.publish("SnapController:snapEnabled",this.getTruncatedExpect(t))}async disableSnap(t){if(!this.has(t))throw new Error(`Snap "${t}" not found.`);this.update(e=>{e.snaps[t].enabled=!1}),this.isRunning(t)&&await this.stopSnap(t,m.SnapStatusEvents.Stop),this.messagingSystem.publish("SnapController:snapDisabled",this.getTruncatedExpect(t))}async stopSnap(t,e=m.SnapStatusEvents.Stop){const s=c(Z,this,Wt).call(this,t);if(!s)throw new Error(`The snap "${t}" is not running.`);if(s.stopPromise)return void await s.stopPromise;const{promise:n,resolve:a}=(0,f.createDeferredPromise)();s.stopPromise=n;try{var i;if(this.isRunning(t))null===(i=r(R,this))||void 0===i||i.call(this,t),await c(Z,this,dt).call(this,t)}finally{s.lastRequest=null,s.pendingInboundRequests=[],s.pendingOutboundRequests=0,s.stopPromise=null,this.isRunning(t)&&c(Z,this,ut).call(this,t,e),a()}}async stopAllSnaps(t=m.SnapStatusEvents.Stop){const e=Object.values(this.state.snaps).filter(t=>this.isRunning(t.id)).map(async e=>this.stopSnap(e.id,t));await Promise.allSettled(e)}isRunning(t){return"running"===this.getExpect(t).status}has(t){return Boolean(this.get(t))}get(t){return this.state.snaps[t]}getExpect(t){const e=this.get(t);return(0,f.assert)(e!==undefined,new Error(`Snap "${t}" not found.`)),e}getTruncated(t){const e=this.get(t);return e?C(e):null}getTruncatedExpect(t){return C(this.getExpect(t))}async updateSnapState(t,e,s){const n=c(Z,this,zt).call(this,t);s?n.state=e:n.unencryptedState=e,r(Q,this).call(this,t,e,s)}clearSnapState(t,e){const s=c(Z,this,zt).call(this,t);e?s.state=null:s.unencryptedState=null,r(Q,this).call(this,t,null,e)}async getSnapState(t,e){const s=c(Z,this,zt).call(this,t);return await s.getStateMutex.runExclusive(async()=>{const n=e?s.state:s.unencryptedState;if(n!==undefined)return n;const a=e?this.state.snapStates[t]:this.state.unencryptedSnapStates[t];if(null===a||a===undefined)return null;if(!e){const t=JSON.parse(a);return s.unencryptedState=t,t}const i=await c(Z,this,mt).call(this,t,a);return s.state=i,i})}async getSnapFile(t,e,s=p.AuxiliaryFileEncoding.Base64){var n;const a=this.getExpect(t),i=(0,m.normalizeRelative)(e),r=null===(n=a.auxiliaryFiles)||void 0===n||null===(n=n.find(t=>t.path===i))||void 0===n?void 0:n.value;if(!r)return null;const o=await(0,m.encodeAuxiliaryFile)(r,s);return(0,f.assert)(o.length<m.MAX_FILE_SIZE,`Failed to encode static file to "${s}": Static files must be less than 64 MB when encoded.`),o}isMinimumPlatformVersion(t,e){const s=this.getExpect(t),{platformVersion:n}=s.manifest;return!!n&&(0,v.gte)(n,e)}async clearState(){const t=Object.keys(this.state.snaps);await this.stopAllSnaps(),t.forEach(t=>c(Z,this,wt).call(this,t)),this.update(t=>{t.snaps={},t.snapStates={},t.unencryptedSnapStates={}}),r(B,this).clear(),r(W,this).clear(),r(Y,this)&&c(Z,this,st).call(this,r(Y,this))}async removeSnap(t){return this.removeSnaps([t])}async removeSnaps(t){if(!Array.isArray(t))throw new Error("Expected array of snap ids.");t.forEach(t=>{const e=this.getExpect(t);(0,f.assert)(!1!==e.removable,`${t} is not removable.`)}),await Promise.all(t.map(async t=>{const e=this.getExpect(t),s=this.getTruncatedExpect(t);await this.disableSnap(t),c(Z,this,wt).call(this,t),c(Z,this,vt).call(this,t),r(B,this).delete(t),this.update(e=>{delete e.snaps[t],delete e.snapStates[t],delete e.unencryptedSnapStates[t]}),e.status!==m.SnapStatus.Installing&&this.messagingSystem.publish("SnapController:snapUninstalled",s)}))}removeSnapFromSubject(t,e){var s,n;const a=this.messagingSystem.call("PermissionController:getPermissions",t),i=null==a||null===(s=a[h.WALLET_SNAP_PERMISSION_KEY])||void 0===s||null===(s=s.caveats)||void 0===s?void 0:s.find(t=>t.type===m.SnapCaveatType.SnapIds);if(!i)return;if(Boolean(null===(n=i.value)||void 0===n?void 0:n[e])){const s={...i.value};delete s[e],Object.keys(s).length>0?this.messagingSystem.call("PermissionController:updateCaveat",t,h.WALLET_SNAP_PERMISSION_KEY,m.SnapCaveatType.SnapIds,s):this.messagingSystem.call("PermissionController:revokePermissions",{[t]:[h.WALLET_SNAP_PERMISSION_KEY]})}}revokeDynamicSnapPermissions(t,e){(0,f.assert)(e.every(t=>r(O,this).includes(t)),"Non-dynamic permissions cannot be revoked"),this.messagingSystem.call("PermissionController:revokePermissions",{[t]:e})}incrementActiveReferences(t){c(Z,this,zt).call(this,t).activeReferences+=1}decrementActiveReferences(t){const e=c(Z,this,zt).call(this,t);(0,f.assert)(e.activeReferences>0,"SnapController reference management is in an invalid state."),e.activeReferences-=1}getAllSnaps(){return Object.values(this.state.snaps).map(C)}getRunnableSnaps(){return(0,E.getRunnableSnaps)(this.getAllSnaps())}getPermittedSnaps(t){var e;const s=(null===(e=(this.messagingSystem.call("PermissionController:getPermissions",t)??{})[h.WALLET_SNAP_PERMISSION_KEY])||void 0===e||null===(e=e.caveats)||void 0===e||null===(e=e.find(t=>t.type===m.SnapCaveatType.SnapIds))||void 0===e?void 0:e.value)??{};return Object.keys(s).reduce((t,e)=>{const s=this.get(e),n=this.getTruncated(e);return n&&(null==s?void 0:s.status)!==m.SnapStatus.Installing&&(t[e]=n),t},{})}async installSnaps(t,e){c(Z,this,ct).call(this);const s={},n=Object.keys(e),a=[],i=[];try{for(const[n,{version:o}]of Object.entries(e)){(0,m.assertIsValidSnapId)(n);const[e,l]=(0,m.resolveVersionRange)(o);if(e)throw d.rpcErrors.invalidParams(`The "version" field must be a valid SemVer version range if specified. Received: "${o}".`);const u=r(q,this).call(this,n,{versionRange:l,fetch:r(L,this),allowLocal:r(N,this).allowLocalSnaps,resolveVersion:async t=>r(N,this).requireAllowlist?await c(Z,this,Et).call(this,n,t):t}),h=this.has(n)&&!u.shouldAlwaysReload;if(h&&c(Z,this,Xt).call(this,n,l)){const t=this.getExpect(n);a.push({snapId:n,oldVersion:t.version});let e=c(Z,this,Ut).call(this,n);if(e!==undefined)throw new Error("This snap is already being updated.");e=c(Z,this,Vt).call(this,n),e.newVersion=l}else h||i.push(n);s[n]=await this.processRequestedSnap(t,n,u,l)}i.forEach(e=>this.messagingSystem.publish("SnapController:snapInstalled",this.getTruncatedExpect(e),t,!1)),a.forEach(({snapId:e,oldVersion:s})=>this.messagingSystem.publish("SnapController:snapUpdated",this.getTruncatedExpect(e),s,t,!1)),n.forEach(t=>r(W,this).delete(t))}catch(t){const e=i.filter(t=>this.has(t));await this.removeSnaps(e);const s=[...r(W,this).keys()],n=a.map(({snapId:t})=>t).filter(t=>s.includes(t));throw await c(Z,this,Bt).call(this,n),t}return s}async processRequestedSnap(t,e,n,a){const i=this.getTruncated(e);if(i&&!n.shouldAlwaysReload)return(0,f.satisfiesVersionRange)(i.version,a)?i:await this.updateSnap(t,e,n,a,!1);c(Z,this,ot).call(this);let r=c(Z,this,_t).call(this,{origin:t,snapId:e,type:s.SNAP_APPROVAL_INSTALL});this.messagingSystem.publish("SnapController:snapInstallStarted",e,t,!1),i&&this.isRunning(e)&&await this.stopSnap(e,m.SnapStatusEvents.Stop),i&&n.shouldAlwaysReload&&c(Z,this,wt).call(this,e);try{const{sourceCode:i}=await c(Z,this,Tt).call(this,{origin:t,id:e,location:n,versionRange:a});await this.authorize(e,r),r=c(Z,this,_t).call(this,{origin:t,snapId:e,type:s.SNAP_APPROVAL_RESULT}),await c(Z,this,kt).call(this,{snapId:e,sourceCode:i});const o=this.getTruncatedExpect(e);return c(Z,this,bt).call(this,r.id,{loading:!1,type:s.SNAP_APPROVAL_INSTALL}),o}catch(n){(0,m.logError)(`Error when adding ${e}.`,n);const a=n instanceof Error?n.message:n.toString();throw c(Z,this,bt).call(this,r.id,{loading:!1,type:s.SNAP_APPROVAL_INSTALL,error:a}),this.messagingSystem.publish("SnapController:snapInstallFailed",e,t,!1,a),n}}async updateSnap(t,e,n,a=m.DEFAULT_REQUESTED_SNAP_VERSION,i=!0){c(Z,this,ot).call(this),c(Z,this,ct).call(this);const r=this.getExpect(e);if(r.preinstalled)throw new Error("Preinstalled Snaps cannot be manually updated.");if(!(0,f.isValidSemVerRange)(a))throw new Error(`Received invalid snap version range: "${a}".`);let o=c(Z,this,_t).call(this,{origin:t,snapId:e,type:s.SNAP_APPROVAL_UPDATE});try{this.messagingSystem.publish("SnapController:snapInstallStarted",e,t,!0);const l=r.manifest,u=await(0,M.fetchSnap)(e,n),{sourceCode:p,manifest:g}=u,y=g.result,S=y.version;if(!(0,f.gtVersion)(S,r.version))throw d.rpcErrors.invalidParams(`Snap "${e}@${r.version}" is already installed. Couldn't update to a version inside requested "${a}" range.`);if(!(0,f.satisfiesVersionRange)(S,a))throw new Error(`Version mismatch. Manifest for "${e}" specifies version "${S}" which doesn't satisfy requested version range "${a}".`);await c(Z,this,rt).call(this,e,{version:S,checksum:y.source.shasum,permissions:y.initialPermissions,platformVersion:y.platformVersion});const v=(0,h.processSnapPermissions)(y.initialPermissions);c(Z,this,At).call(this,v);const{newPermissions:w,unusedPermissions:_,approvedPermissions:b}=c(Z,this,Yt).call(this,e,v),{newConnections:E,unusedConnections:T,approvedConnections:k}=c(Z,this,Jt).call(this,e,l.initialConnections??{},y.initialConnections??{});c(Z,this,bt).call(this,o.id,{permissions:w,newVersion:y.version,newPermissions:w,approvedPermissions:b,unusedPermissions:_,newConnections:E,unusedConnections:T,approvedConnections:k,loading:!1});const{permissions:P,...A}=await o.promise;o=c(Z,this,_t).call(this,{origin:t,snapId:e,type:s.SNAP_APPROVAL_RESULT}),this.isRunning(e)&&await this.stopSnap(e,m.SnapStatusEvents.Stop),c(Z,this,ut).call(this,e,m.SnapStatusEvents.Update),c(Z,this,Mt).call(this,{origin:t,id:e,files:u,isUpdate:!0}),c(Z,this,Qt).call(this,{snapId:e,unusedPermissions:_,newPermissions:P,requestData:A}),y.initialConnections&&c(Z,this,yt).call(this,e,l.initialConnections??null,y.initialConnections);const I=c(Z,this,Ut).call(this,e);I!==undefined&&(I.permissions.revoked=_,I.permissions.granted=P,I.permissions.requestData=A);const C=p.toString();(0,f.assert)("string"==typeof C&&C.length>0,`Invalid source code for snap "${e}".`);try{await c(Z,this,kt).call(this,{snapId:e,sourceCode:C})}catch{throw new Error(`Snap ${e} crashed with updated source code.`)}const R=this.getTruncatedExpect(e);return i&&this.messagingSystem.publish("SnapController:snapUpdated",R,r.version,t,!1),c(Z,this,bt).call(this,o.id,{loading:!1,type:s.SNAP_APPROVAL_UPDATE}),R}catch(n){(0,m.logError)(`Error when updating ${e},`,n);const a=n instanceof Error?n.message:n.toString();throw c(Z,this,bt).call(this,o.id,{loading:!1,error:a,type:s.SNAP_APPROVAL_UPDATE}),this.messagingSystem.publish("SnapController:snapInstallFailed",e,t,!0,a),n}}async authorize(t,e){(0,P.log)(`Authorizing snap: ${t}`);const s=this.state.snaps[t],{initialPermissions:n,initialConnections:a}=s;try{const i=(0,h.processSnapPermissions)(n);c(Z,this,At).call(this,i),c(Z,this,bt).call(this,e.id,{loading:!1,connections:a??{},permissions:i});const{permissions:r,...o}=await e.promise;c(Z,this,Qt).call(this,{snapId:t,newPermissions:r,requestData:o}),s.manifest.initialConnections&&c(Z,this,yt).call(this,t,null,s.manifest.initialConnections)}finally{c(Z,this,zt).call(this,t).installPromise=null}}destroy(){super.destroy(),r(z,this)&&clearTimeout(r(z,this)),this.messagingSystem.unsubscribe("ExecutionService:unhandledError",this._onUnhandledSnapError),this.messagingSystem.unsubscribe("ExecutionService:outboundRequest",this._onOutboundRequest),this.messagingSystem.unsubscribe("ExecutionService:outboundResponse",this._onOutboundResponse),this.messagingSystem.clearEventSubscriptions("SnapController:snapInstalled"),this.messagingSystem.clearEventSubscriptions("SnapController:snapUpdated")}async handleRequest({snapId:t,origin:e,handler:s,request:n}){c(Z,this,ct).call(this),(0,f.assert)(e===w.METAMASK_ORIGIN||(0,m.isValidUrl)(e),"'origin' must be a valid URL or 'metamask'.");const a={jsonrpc:"2.0",id:(0,S.nanoid)(),...n};(0,f.assertIsJsonRpcRequest)(a);const i=h.handlerEndowments[s];(0,f.assert)("string"==typeof i||null===i,"'permissionName' must be either a string or null.");const r=this.messagingSystem.call("PermissionController:getPermissions",t);if(!(null===i||r&&(0,f.hasProperty)(r,i)))throw new Error(`Snap "${t}" is not permitted to use "${i}".`);const o=i?r[i]:undefined;if(i===h.SnapEndowments.Rpc||i===h.SnapEndowments.Keyring){(0,f.assert)(o);const s=this.messagingSystem.call("SubjectMetadataController:getSubjectMetadata",e),n=i===h.SnapEndowments.Rpc?(0,h.getRpcCaveatOrigins)(o):(0,h.getKeyringCaveatOrigins)(o);if((0,f.assert)(n),!(0,m.isOriginAllowed)(n,(null==s?void 0:s.subjectType)??u.SubjectType.Website,e))throw new Error(`Snap "${t}" is not permitted to handle requests from "${e}".`)}if(e!==w.METAMASK_ORIGIN&&w.CLIENT_ONLY_HANDLERS.includes(s))throw new Error(`"${s}" can only be invoked by MetaMask.`);if(!this.state.snaps[t].enabled)throw new Error(`Snap "${t}" is disabled.`);if(this.state.snaps[t].status===m.SnapStatus.Installing)throw new Error(`Snap "${t}" is currently being installed. Please try again later.`);const l=c(Z,this,Ct).call(this,o),d=c(Z,this,zt).call(this,t);if(d.stopPromise&&await d.stopPromise,!this.isRunning(t)){d.startPromise||(d.startPromise=this.startSnap(t));try{await d.startPromise}finally{d.startPromise=null}}const p=c(Z,this,Dt).call(this,t,s,a),g=new T.Timer(l);c(Z,this,$t).call(this,t,p.id,g);const y=this.messagingSystem.call("ExecutionService:handleRpcRequest",t,{origin:e,handler:s,request:p});try{const n=await(0,M.withTimeout)(y,g);if(n===M.hasTimedOut){const e=null!==d.stopPromise||!this.isRunning(t);throw new Error(e?`${t} was stopped and the request was cancelled. This is likely because the Snap crashed.`:`${t} failed to respond to the request in time.`)}await c(Z,this,Ht).call(this,t,s,n);const a=await c(Z,this,jt).call(this,t,s,p,n);return c(Z,this,Ft).call(this,t,p.id,s,e,!0),a}catch(n){c(Z,this,Ft).call(this,t,p.id,s,e,!1);const[a,i]=(0,m.unwrapError)(n),r=null!==d.stopPromise||!this.isRunning(t);throw i||(r||(0,m.logError)(`"${t}" crashed due to an unhandled error:`,a),await this.stopSnap(t,m.SnapStatusEvents.Crash)),a}}setClientActive(t){t?c(Z,this,te).call(this,w.METAMASK_ORIGIN,m.HandlerType.OnActive):c(Z,this,te).call(this,w.METAMASK_ORIGIN,m.HandlerType.OnInactive)}}function tt(){const t=({snapId:t})=>this.getExpect(t).enabled,e={initial:m.SnapStatus.Installing,states:{[m.SnapStatus.Installing]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:t}}},[m.SnapStatus.Updating]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:t},[m.SnapStatusEvents.Stop]:m.SnapStatus.Stopped}},[m.SnapStatus.Running]:{on:{[m.SnapStatusEvents.Stop]:m.SnapStatus.Stopped,[m.SnapStatusEvents.Crash]:m.SnapStatus.Crashed}},[m.SnapStatus.Stopped]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:t},[m.SnapStatusEvents.Update]:m.SnapStatus.Updating}},[m.SnapStatus.Crashed]:{on:{[m.SnapStatusEvents.Start]:{target:m.SnapStatus.Running,cond:t},[m.SnapStatusEvents.Update]:m.SnapStatus.Updating}}}};o(G,this,(0,g.createMachine)(e)),(0,k.validateMachine)(r(G,this))}function et(){this.messagingSystem.registerActionHandler(`${s.controllerName}:init`,(...t)=>this.init(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:clearSnapState`,(...t)=>this.clearSnapState(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:get`,(...t)=>this.get(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:getSnapState`,async(...t)=>this.getSnapState(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:handleRequest`,async(...t)=>this.handleRequest(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:has`,(...t)=>this.has(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:updateBlockedSnaps`,async()=>this.updateBlockedSnaps()),this.messagingSystem.registerActionHandler(`${s.controllerName}:updateSnapState`,async(...t)=>this.updateSnapState(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:enable`,(...t)=>this.enableSnap(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:disable`,async(...t)=>this.disableSnap(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:remove`,async(...t)=>this.removeSnap(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:getPermitted`,(...t)=>this.getPermittedSnaps(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:install`,async(...t)=>this.installSnaps(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:getAll`,(...t)=>this.getAllSnaps(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:getRunnableSnaps`,(...t)=>this.getRunnableSnaps(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:incrementActiveReferences`,(...t)=>this.incrementActiveReferences(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:decrementActiveReferences`,(...t)=>this.decrementActiveReferences(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:disconnectOrigin`,(...t)=>this.removeSnapFromSubject(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:revokeDynamicPermissions`,(...t)=>this.revokeDynamicSnapPermissions(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:getFile`,async(...t)=>this.getSnapFile(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:stopAllSnaps`,async(...t)=>this.stopAllSnaps(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:isMinimumPlatformVersion`,(...t)=>this.isMinimumPlatformVersion(...t)),this.messagingSystem.registerActionHandler(`${s.controllerName}:setClientActive`,(...t)=>this.setClientActive(...t))}function st(t){for(const{snapId:s,manifest:n,files:a,removable:i,hidden:r,hideSnapBranding:o}of t){var e;const t=this.get(s),l=t!==undefined,u=l&&(0,f.gtVersion)(n.version,t.version);if(l&&(!u||!0!==t.preinstalled))continue;const d=new m.VirtualFile({path:m.NpmSnapFileNames.Manifest,value:JSON.stringify(n),result:n}),p=a.map(({path:t,value:e})=>new m.VirtualFile({value:e,path:t})),{filePath:g,iconPath:y}=n.source.location.npm,S=p.find(t=>t.path===g),v=y?p.find(t=>t.path===y):undefined;(0,f.assert)(S,"Source code not provided for preinstalled snap."),(0,f.assert)(!y||y&&v,"Icon not provided for preinstalled snap."),(0,f.assert)(n.source.files===undefined,"Auxiliary files are not currently supported for preinstalled snaps.");const _=(null===(e=n.source.locales)||void 0===e?void 0:e.map(t=>p.find(e=>e.path===t)))??[],b=(0,m.getValidatedLocalizationFiles)(_.filter(Boolean));(0,f.assert)(_.length===b.length,"Missing localization files for preinstalled snap.");const E={manifest:d,sourceCode:S,svgIcon:v,auxiliaryFiles:[],localizationFiles:b};c(Z,this,Mt).call(this,{id:s,origin:w.METAMASK_ORIGIN,files:E,removable:i,hidden:r,hideSnapBranding:o,preinstalled:!0});const T=(0,h.processSnapPermissions)(n.initialPermissions);c(Z,this,At).call(this,T);const{newPermissions:k,unusedPermissions:P}=c(Z,this,Yt).call(this,s,T);c(Z,this,Qt).call(this,{snapId:s,newPermissions:k,unusedPermissions:P}),n.initialConnections&&c(Z,this,yt).call(this,s,(null==t?void 0:t.initialConnections)??null,n.initialConnections),this.update(t=>{t.snaps[s].status=m.SnapStatus.Stopped}),c(Z,this,Gt).call(this,s),u?this.messagingSystem.publish("SnapController:snapUpdated",this.getTruncatedExpect(s),t.version,w.METAMASK_ORIGIN,!0):this.messagingSystem.publish("SnapController:snapInstalled",this.getTruncatedExpect(s),w.METAMASK_ORIGIN,!0)}}function nt(){o(z,this,setTimeout(()=>{c(Z,this,lt).call(this).catch(t=>{(0,m.logError)(t)}),c(Z,this,nt).call(this)},r(D,this)))}async function at(t,e){if(this.has(t)){try{this.update(s=>{s.snaps[t].blocked=!0,s.snaps[t].blockInformation=e}),await this.disableSnap(t)}catch(e){(0,m.logError)(`Encountered error when stopping blocked snap "${t}".`,e)}this.messagingSystem.publish(`${s.controllerName}:snapBlocked`,t,e)}}function it(t){this.has(t)&&this.state.snaps[t].blocked&&(this.update(e=>{e.snaps[t].blocked=!1,delete e.snaps[t].blockInformation}),this.messagingSystem.publish(`${s.controllerName}:snapUnblocked`,t))}async function rt(t,{platformVersion:e,...s}){const n=(await this.messagingSystem.call("SnapsRegistry:get",{[t]:s}))[t];var a;if(n.status===b.SnapsRegistryStatus.Blocked)throw new Error(`Cannot install version "${s.version}" of snap "${t}": The version is blocked. ${(null===(a=n.reason)||void 0===a?void 0:a.explanation)??""}`);const i=Object.keys(s.permissions).some(t=>!w.ALLOWED_PERMISSIONS.includes(t));if(r(N,this).requireAllowlist&&i&&n.status!==b.SnapsRegistryStatus.Verified)throw new Error(`Cannot install version "${s.version}" of snap "${t}": ${n.status===b.SnapsRegistryStatus.Unavailable?"The registry is temporarily unavailable.":"The snap is not on the allowlist."}`);c(Z,this,It).call(this,t,e)}function ot(){(0,f.assert)(!0!==r(N,this).disableSnapInstallation,"Installing Snaps is currently disabled in this version of MetaMask.")}function ct(){const t=r(U,this).call(this);(0,f.assert)(!0!==t.disableSnaps,"The Snaps platform requires basic functionality to be used. Enable basic functionality in the settings to use the Snaps platform.")}async function lt(){const t=[...r(B,this).entries()];return Promise.all(t.filter(([t,e])=>0===e.activeReferences&&0===e.pendingInboundRequests.length&&e.lastRequest&&r(H,this)&&(0,f.timeSince)(e.lastRequest)>r(H,this)).map(async([t])=>this.stopSnap(t,m.SnapStatusEvents.Stop)))}function ut(t,e){const{interpreter:s}=c(Z,this,zt).call(this,t);s.send(e),this.update(e=>{e.snaps[t].status=s.state.value})}async function dt(t){await this.messagingSystem.call("ExecutionService:terminateSnap",t),await new Promise(t=>setTimeout(t,1));c(Z,this,zt).call(this,t).pendingInboundRequests.filter(t=>"finished"!==t.timer.status).forEach(t=>t.timer.finish()),await new Promise(t=>setTimeout(t,1)),this.messagingSystem.publish("SnapController:snapTerminated",this.getTruncatedExpect(t))}function ht(t,e=c(Z,this,zt).call(this,t)){return null!==e.encryptionKey&&null!==e.encryptionSalt}async function pt({snapId:t,salt:e,useCache:s,keyMetadata:n}){const a=c(Z,this,zt).call(this,t);if(c(Z,this,ht).call(this,t,a)&&s)return{key:await r($,this).importKey(a.encryptionKey),salt:a.encryptionSalt};const i=e??r($,this).generateSalt(),o=await r(F,this).call(this),l=await(0,h.getEncryptionEntropy)({snapId:t,seed:o,cryptographicFunctions:r(V,this)}),u=await r($,this).keyFromPassword(l,i,!0,n),d=await r($,this).exportKey(u);return s&&(a.encryptionKey=d,a.encryptionSalt=i),{key:u,salt:i}}async function mt(t,e){try{const s=JSON.parse(e),{salt:n,keyMetadata:a}=s,i=c(Z,this,ht).call(this,t)||r($,this).isVaultUpdated(e),{key:o}=await c(Z,this,pt).call(this,{snapId:t,salt:n,useCache:i,keyMetadata:a??w.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS});return await r($,this).decryptWithKey(o,s)}catch{throw d.rpcErrors.internal({message:"Failed to decrypt snap state, the state must be corrupted."})}}async function ft(t,e){const{key:s,salt:n}=await c(Z,this,pt).call(this,{snapId:t,useCache:!0}),a=await r($,this).encryptWithKey(s,e);return a.salt=n,JSON.stringify(a)}async function gt(t,e,s){return null===e?null:s?await c(Z,this,ft).call(this,t,e):JSON.stringify(e)}function yt(t,e,s){if(e){const n=(0,M.setDiff)(e,s);for(const e of Object.keys(n))this.removeSnapFromSubject(e,t)}for(const e of Object.keys(s))c(Z,this,St).call(this,e,t)}function St(t,e){var s,n;const a=this.messagingSystem.call("PermissionController:getPermissions",t),i=null==a||null===(s=a[h.WALLET_SNAP_PERMISSION_KEY])||void 0===s||null===(s=s.caveats)||void 0===s?void 0:s.find(t=>t.type===m.SnapCaveatType.SnapIds);if(Boolean(null==i||null===(n=i.value)||void 0===n?void 0:n[e]))return;if(i)return void this.messagingSystem.call("PermissionController:updateCaveat",t,h.WALLET_SNAP_PERMISSION_KEY,m.SnapCaveatType.SnapIds,{...i.value,[e]:{}});const r={[h.WALLET_SNAP_PERMISSION_KEY]:{caveats:[{type:m.SnapCaveatType.SnapIds,value:{[e]:{}}}]}};this.messagingSystem.call("PermissionController:grantPermissions",{approvedPermissions:r,subject:{origin:t}})}function vt(t){const e=this.messagingSystem.call("PermissionController:getSubjectNames");for(const s of e)this.removeSnapFromSubject(s,t)}function wt(t){this.messagingSystem.call("PermissionController:hasPermissions",t)&&this.messagingSystem.call("PermissionController:revokeAllPermissions",t)}function _t({origin:t,snapId:e,type:s}){const n=(0,S.nanoid)();return{id:n,promise:this.messagingSystem.call("ApprovalController:addRequest",{origin:t,id:n,type:s,requestData:{metadata:{id:n,origin:e,dappOrigin:t},snapId:e},requestState:{loading:!0}},!0)}}function bt(t,e){try{this.messagingSystem.call("ApprovalController:updateRequestState",{id:t,requestState:e})}catch{}}async function Et(t,e){return await this.messagingSystem.call("SnapsRegistry:resolveVersion",t,e)}async function Tt(t){const{id:e,location:s,versionRange:n}=t;c(Z,this,Gt).call(this,e);const a=c(Z,this,zt).call(this,e);a.installPromise||((0,P.log)(`Adding snap: ${e}`),a.installPromise=(async()=>{const a=await(0,M.fetchSnap)(e,s),i=a.manifest.result;if(!(0,f.satisfiesVersionRange)(i.version,n))throw new Error(`Version mismatch. Manifest for "${e}" specifies version "${i.version}" which doesn't satisfy requested version range "${n}".`);await c(Z,this,rt).call(this,e,{version:i.version,checksum:i.source.shasum,permissions:i.initialPermissions,platformVersion:i.platformVersion});const o=r(N,this).forcePreinstalledSnaps&&(0,M.isLocalSnapId)(e)?{preinstalled:!0,hideSnapBranding:!0,hidden:!1}:{};return c(Z,this,Mt).call(this,{...t,files:a,id:e,...o})})());try{return await a.installPromise}catch(t){throw a.installPromise=null,t}}async function kt(t){const{snapId:e}=t;if(this.isRunning(e))throw new Error(`Snap "${e}" is already started.`);try{const s=c(Z,this,zt).call(this,e),n=await this.messagingSystem.call("ExecutionService:executeSnap",{...t,endowments:await c(Z,this,Pt).call(this,e)});return c(Z,this,ut).call(this,e,m.SnapStatusEvents.Start),s.lastRequest=Date.now(),n}catch(t){throw await c(Z,this,dt).call(this,e),t}}async function Pt(t){let e=[];for(const s of r(j,this))if(this.messagingSystem.call("PermissionController:hasPermission",t,s)){const n=await this.messagingSystem.call("PermissionController:getEndowments",t,s);if(n){if(!Array.isArray(n)||n.some(t=>"string"!=typeof t))throw new Error("Expected an array of string endowment names.");e=e.concat(n)}}const s=[...new Set([...m.DEFAULT_ENDOWMENTS,...e])];return s.length<m.DEFAULT_ENDOWMENTS.length+e.length&&(0,m.logError)(`Duplicate endowments found for ${t}. Default endowments should not be requested.`,e),s}function Mt(t){const{id:e,origin:s,files:n,isUpdate:a=!1,removable:i,preinstalled:o,hidden:l,hideSnapBranding:d}=t,{manifest:h,sourceCode:p,svgIcon:g,auxiliaryFiles:y,localizationFiles:S}=n;(0,m.assertIsSnapManifest)(h.result);const{version:v}=h.result,w=p.toString();(0,f.assert)("string"==typeof w&&w.length>0,`Invalid source code for snap "${e}".`);const _=y.map(t=>((0,f.assert)("string"==typeof t.data.base64),{path:t.path,value:t.data.base64})),b=this.state.snaps[e],E=[...(null==b?void 0:b.versionHistory)??[],{version:v,date:Date.now(),origin:s}],T=S.map(t=>t.result),k={...b,blocked:!1,enabled:!0,removable:i,preinstalled:o,hidden:l,hideSnapBranding:d,id:e,initialConnections:h.result.initialConnections,initialPermissions:h.result.initialPermissions,manifest:h.result,status:r(G,this).config.initial,sourceCode:w,version:v,versionHistory:E,auxiliaryFiles:_,localizationFiles:T};delete k.blockInformation;const{inversePatches:P}=this.update(t=>{t.snaps[e]=k});if(a){const t=c(Z,this,Ut).call(this,e);t!==undefined&&(t.statePatches=P)}const{proposedName:M}=(0,m.getLocalizedSnapManifest)(h.result,"en",T);return this.messagingSystem.call("SubjectMetadataController:addSubjectMetadata",{subjectType:u.SubjectType.Snap,name:M,origin:k.id,version:v,svgIcon:(null==g?void 0:g.toString())??null}),{...k,sourceCode:w}}function At(t){const e=Object.keys(t),s=Array.from(new Set(Object.values(h.handlerEndowments)));(0,f.assert)(e.some(t=>s.includes(t)),`A snap must request at least one of the following permissions: ${s.filter(t=>null!==t).join(", ")}.`);const n=e.reduce((t,e)=>((0,f.hasProperty)(r(x,this),e)&&t.push(r(x,this)[e]),t),[]);(0,f.assert)(0===n.length,`One or more permissions are not allowed:\n${n.join("\n")}`)}function It(t,e){if(e!==undefined&&(0,v.gt)(e,(0,m.getPlatformVersion)())){const s=`The Snap "${t}" requires platform version "${e}" which is greater than the current platform version "${(0,m.getPlatformVersion)()}".`;if(r(N,this).rejectInvalidPlatformVersion)throw new Error(s);(0,m.logWarning)(s)}}function Ct(t){return(0,h.getMaxRequestTimeCaveat)(t)??this.maxRequestTime}async function Rt(t,e,s){return this.messagingSystem.call("SnapInterfaceController:createInterface",t,e,undefined,s)}function Ot(t,e){(0,f.assert)(this.messagingSystem.call("SnapInterfaceController:getInterface",t,e))}async function jt(t,e,s,n){switch(e){case m.HandlerType.OnTransaction:case m.HandlerType.OnSignature:case m.HandlerType.OnHomePage:case m.HandlerType.OnSettingsPage:{const e=n;if(e&&(0,f.hasProperty)(e,"content")){const{content:s,...n}=e;return{...n,id:await c(Z,this,Rt).call(this,t,s)}}return n}case m.HandlerType.OnAssetsLookup:return c(Z,this,xt).call(this,t,s,n);case m.HandlerType.OnAssetsConversion:return c(Z,this,Nt).call(this,s,n);case m.HandlerType.OnAssetsMarketData:return c(Z,this,Lt).call(this,s,n);default:return n}}function xt(t,{params:e},{assets:s}){const n=this.messagingSystem.call("PermissionController:getPermissions",t);(0,f.assert)(n);const a=n[h.SnapEndowments.Assets],i=(0,h.getChainIdsCaveat)(a);(0,f.assert)(i);const{assets:r}=e;return{assets:Object.keys(s).reduce((t,e)=>{const n=e;return i.some(t=>n.startsWith(t))&&r.includes(n)&&(t[n]=s[n]),t},{})}}function Nt({params:t},{conversionRates:e}){const{conversions:s}=t;return{conversionRates:s.reduce((t,s)=>{var n;const a=null===(n=e[s.from])||void 0===n?void 0:n[s.to];var i;a&&(t[i=s.from]??(t[i]={}),t[s.from][s.to]=a);return t},{})}}function Lt({params:t},{marketData:e}){const{assets:s}=t;return{marketData:s.reduce((t,s)=>{var n;const a=null===(n=e[s.asset])||void 0===n?void 0:n[s.unit];var i;a&&(t[i=s.asset]??(t[i]={}),t[s.asset][s.unit]=a);return t},{})}}function Dt(t,e,s){if(e===m.HandlerType.OnUserInput){(0,f.assert)(s.params&&(0,f.hasProperty)(s.params,"id"));const e=s.params.id,{context:n}=this.messagingSystem.call("SnapInterfaceController:getInterface",t,e);return{...s,params:{...s.params,context:n}}}return s}async function Ht(t,e,s){switch(e){case m.HandlerType.OnTransaction:(0,f.assertStruct)(s,m.OnTransactionResponseStruct),s&&(0,f.hasProperty)(s,"id")&&c(Z,this,Ot).call(this,t,s.id);break;case m.HandlerType.OnSignature:(0,f.assertStruct)(s,m.OnSignatureResponseStruct),s&&(0,f.hasProperty)(s,"id")&&c(Z,this,Ot).call(this,t,s.id);break;case m.HandlerType.OnHomePage:(0,f.assertStruct)(s,m.OnHomePageResponseStruct),s&&(0,f.hasProperty)(s,"id")&&c(Z,this,Ot).call(this,t,s.id);break;case m.HandlerType.OnSettingsPage:(0,f.assertStruct)(s,m.OnSettingsPageResponseStruct),s&&(0,f.hasProperty)(s,"id")&&c(Z,this,Ot).call(this,t,s.id);break;case m.HandlerType.OnNameLookup:(0,f.assertStruct)(s,m.OnNameLookupResponseStruct);break;case m.HandlerType.OnAssetsLookup:(0,f.assertStruct)(s,p.OnAssetsLookupResponseStruct);break;case m.HandlerType.OnAssetsConversion:(0,f.assertStruct)(s,m.OnAssetsConversionResponseStruct);break;case m.HandlerType.OnAssetHistoricalPrice:(0,f.assertStruct)(s,m.OnAssetHistoricalPriceResponseStruct);break;case m.HandlerType.OnAssetsMarketData:(0,f.assertStruct)(s,m.OnAssetsMarketDataResponseStruct)}}function $t(t,e,s){const n=c(Z,this,zt).call(this,t);n.pendingInboundRequests.push({requestId:e,timer:s}),n.lastRequest=null}function Ft(t,e,s,n,a){const i=c(Z,this,zt).call(this,t);i.pendingInboundRequests=i.pendingInboundRequests.filter(t=>t.requestId!==e),0===i.pendingInboundRequests.length&&(i.lastRequest=Date.now());const o=this.get(t);if((0,M.isTrackableHandler)(s)&&(null==o||!o.preinstalled))try{r(J,this).call(this,t,s,a,n)}catch(t){(0,m.logError)(`Error when calling MetaMetrics hook for snap "${null==o?void 0:o.id}": ${(0,p.getErrorMessage)(t)}`)}}function Ut(t){return r(W,this).get(t)}function Vt(t){(0,f.assert)(r(W,this).get(t)===undefined,new Error(`Snap "${t}" rollback snapshot already exists.`)),r(W,this).set(t,{statePatches:[],permissions:{},newVersion:""});const e=r(W,this).get(t);return(0,f.assert)(e!==undefined,new Error(`Snapshot creation failed for ${t}.`)),e}async function qt(t){var e,s;const n=c(Z,this,Ut).call(this,t);if(!n)throw new Error("A snapshot does not exist for this snap.");await this.stopSnap(t,m.SnapStatusEvents.Stop),(null===(e=this.get(t))||void 0===e?void 0:e.status)!==m.SnapStatus.Stopped&&c(Z,this,ut).call(this,t,m.SnapStatusEvents.Stop);const{statePatches:a,permissions:i}=n;null!=a&&a.length&&this.applyPatches(a),(null===(s=this.get(t))||void 0===s?void 0:s.status)!==m.SnapStatus.Stopped&&this.update(e=>{e.snaps[t].status=m.SnapStatus.Stopped}),c(Z,this,Qt).call(this,{snapId:t,unusedPermissions:i.granted,newPermissions:i.revoked,requestData:i.requestData});const o=this.getTruncatedExpect(t);this.messagingSystem.publish("SnapController:snapRolledback",o,n.newVersion),r(W,this).delete(t)}async function Bt(t){for(const e of t)await c(Z,this,qt).call(this,e)}function Wt(t){return r(B,this).get(t)}function zt(t){const e=c(Z,this,Wt).call(this,t);return(0,f.assert)(e!==undefined,new Error(`Snap "${t}" runtime data not found`)),e}function Gt(t){if(r(B,this).has(t))return;const e=this.get(t),s=(0,g.interpret)(r(G,this));s.start({context:{snapId:t},value:(null==e?void 0:e.status)??r(G,this).config.initial}),(0,k.forceStrict)(s),r(B,this).set(t,{lastRequest:null,startPromise:null,stopPromise:null,installPromise:null,encryptionKey:null,encryptionSalt:null,activeReferences:0,pendingInboundRequests:[],pendingOutboundRequests:0,interpreter:s,stateMutex:new y.Mutex,getStateMutex:new y.Mutex})}function Yt(t,e){const s=this.messagingSystem.call("PermissionController:getPermissions",t)??{},n=(0,M.permissionsDiff)(e,s),a=(0,M.permissionsDiff)(s,e);return{newPermissions:n,unusedPermissions:a,approvedPermissions:(0,M.permissionsDiff)(s,a)}}function Kt(t,e){var s,n;const a=this.messagingSystem.call("PermissionController:getPermissions",e),i=null==a||null===(s=a[h.WALLET_SNAP_PERMISSION_KEY])||void 0===s||null===(s=s.caveats)||void 0===s?void 0:s.find(t=>t.type===m.SnapCaveatType.SnapIds);return Boolean(null==i||null===(n=i.value)||void 0===n?void 0:n[t])}function Jt(t,e,s){const n=Object.keys(e).filter(e=>c(Z,this,Kt).call(this,t,e)).reduce((t,s)=>(t[s]=e[s],t),{}),a=(0,M.setDiff)(s,n),i=(0,M.setDiff)(n,s);return{newConnections:a,unusedConnections:i,approvedConnections:(0,M.setDiff)(n,i)}}function Zt(t,e){if(r(N,this).useCaip25Permission&&Object.keys(e).includes(h.SnapEndowments.EthereumProvider)){const s=this.messagingSystem.call("SelectedNetworkController:getNetworkClientIdForDomain",t),{configuration:n}=this.messagingSystem.call("NetworkController:getNetworkClientById",s),a=(0,f.hexToNumber)(n.chainId);return{...e,"endowment:caip25":{caveats:[{type:"authorizedScopes",value:{requiredScopes:{},optionalScopes:{[`eip155:${a}`]:{accounts:[]}},sessionProperties:{},isMultichainOrigin:!1}}]}}}return e}function Qt({snapId:t,unusedPermissions:e={},newPermissions:s={},requestData:n}){const a=Object.keys(e);if((0,f.isNonEmptyArray)(a)&&this.messagingSystem.call("PermissionController:revokePermissions",{[t]:a}),(0,f.isNonEmptyArray)(Object.keys(s))){const e=c(Z,this,Zt).call(this,t,s);this.messagingSystem.call("PermissionController:grantPermissions",{approvedPermissions:e,subject:{origin:t},requestData:n})}}function Xt(t,e){const s=this.getExpect(t);return!(0,f.satisfiesVersionRange)(s.version,e)&&!(0,f.gtRange)(s.version,e)}function te(t,e){const s=this.getRunnableSnaps();for(const{id:n}of s){this.messagingSystem.call("PermissionController:hasPermission",n,h.SnapEndowments.LifecycleHooks)&&c(Z,this,ee).call(this,t,n,e).catch(t=>{(0,m.logError)(`Error calling lifecycle hook "${e}" for Snap "${n}": ${(0,p.getErrorMessage)(t)}`)})}}async function ee(t,e,s){const n=h.handlerEndowments[s];(0,f.assert)(n,"Lifecycle hook must have an endowment.");this.messagingSystem.call("PermissionController:hasPermission",e,n)&&await this.handleRequest({snapId:e,handler:s,origin:t,request:{jsonrpc:"2.0",method:s}})}function se(){for(const t of r(B,this).values())t.encryptionKey=null,t.encryptionSalt=null,t.state=undefined}s.SnapController=X}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/SnapController.cjs"}],[23,{"../../../../shared/constants/metametrics":5259,"../../../../shared/lib/sentry":5336,"../../../../shared/lib/trace":5342,"../../../../shared/modules/environment":5355,"@metamask/profile-sync-controller/user-storage":2141},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.UserStorageControllerInit=void 0;var n=t("@metamask/profile-sync-controller/user-storage"),a=t("../../../../shared/modules/environment"),i=t("../../../../shared/constants/metametrics"),r=t("../../../../shared/lib/trace"),o=t("../../../../shared/lib/sentry");s.UserStorageControllerInit=t=>{const{controllerMessenger:e,initMessenger:s,persistedState:c}=t;return{controller:new n.Controller({messenger:e,state:c.UserStorageController,trace:r.trace,config:{accountSyncing:{maxNumberOfAccountsToAdd:(0,a.isProduction)()?undefined:100,onAccountAdded:t=>{s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.AccountsSyncAdded,properties:{profile_id:t}})},onAccountNameUpdated:t=>{s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.AccountsSyncNameUpdated,properties:{profile_id:t}})},onAccountSyncErroneousSituation:(t,e,n)=>{(0,o.captureException)(new Error(`Account sync - ${e}`),n),s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.AccountsSyncErroneousSituation,properties:{profile_id:t,situation_message:e}})}},contactSyncing:{onContactUpdated:t=>{s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.ProfileActivityUpdated,properties:{profile_id:t,feature_name:"Backup And Sync",action:"Contacts Sync Contact Updated"}})},onContactDeleted:t=>{s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.ProfileActivityUpdated,properties:{profile_id:t,feature_name:"Backup And Sync",action:"Contacts Sync Contact Deleted"}})},onContactSyncErroneousSituation:(t,e,n)=>{(0,o.captureException)(new Error(`Contact sync - ${e}`),n),s.call("MetaMetricsController:trackEvent",{category:i.MetaMetricsEventCategory.BackupAndSync,event:i.MetaMetricsEventName.ProfileActivityUpdated,properties:{profile_id:t,feature_name:"Backup And Sync",action:"Contacts Sync Erroneous Situation",additional_description:e}})}}}})}}}}},{package:"$root$",file:"app/scripts/controller-init/identity/user-storage-controller-init.ts"}],[230,{"../../../../shared/modules/conversion.utils":5354,"../../../../shared/modules/fetch-with-timeout":5358},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.buildUrl=u,s.getSendBundleSupportedChains=async function(t){const e=await c();return t.reduce((t,s)=>{const n=(0,a.hexToDecimal)(s),i=e[n];return t[s]=(null==i?void 0:i.sendBundle)??!1,t},{})},s.getSentinelNetworkFlags=l,s.isSendBundleSupported=async function(t){const e=await l(t);if(null==e||!e.sendBundle)return!1;return!0};var n,a=t("../../../../shared/modules/conversion.utils"),i=(n=t("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n};const r="https://tx-sentinel-{0}.api.cx.metamask.io/",o="networks";async function c(){const t=`${u("ethereum-mainnet")}${o}`;return(await(0,i.default)()(t)).json()}async function l(t){const e=(0,a.hexToDecimal)(t);return(await c())[e]}function u(t){return r.replace("{0}",t)}}}},{package:"$root$",file:"app/scripts/lib/transaction/sentinel-api.ts"}],[2300,{"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}Object.defineProperty(s,"__esModule",{value:!0}),s.Timer=void 0;const a=t("@metamask/utils");s.Timer=class{constructor(t){n(this,"state",void 0),(0,a.assert)(!Number.isNaN(t),new TypeError("Can't start a timer with NaN time")),(0,a.assert)(t>=0,new TypeError("Can't start a timer with negative time")),this.state={value:"stopped",remaining:t}}get status(){return this.state.value}get remaining(){return this.state.remaining}cancel(){(0,a.assert)("paused"===this.status||"running"===this.status,new Error("Tried to cancel a not running Timer")),this.onFinish(!1)}finish(){(0,a.assert)("finished"!==this.status,new Error("Tried to finish a finished Timer.")),this.onFinish(!0)}pause(){(0,a.assert)("running"===this.state.value,new Error("Tried to pause a not running Timer"));const{callback:t,start:e,timeout:s,remaining:n}=this.state;s!==undefined&&clearTimeout(s),this.state={value:"paused",callback:t,remaining:n-(Date.now()-e)}}start(t){(0,a.assert)("stopped"===this.state.value,new Error("Tried to start an already running Timer"));const{remaining:e}=this.state;this.state={value:"paused",remaining:e,callback:t},this.resume()}resume(){(0,a.assert)("paused"===this.state.value,new Error("Tried to resume not paused Timer"));const{remaining:t,callback:e}=this.state,s=Date.now();let n;t!==Number.POSITIVE_INFINITY&&(n=setTimeout(()=>this.onFinish(!0),t)),this.state={value:"running",callback:e,remaining:t,start:s,timeout:n}}onFinish(t){(0,a.assert)("running"===this.state.value||"paused"===this.state.value),"running"===this.state.value&&this.state.timeout!==undefined&&clearTimeout(this.state.timeout);const{callback:e,remaining:s}=this.state;this.state={value:"finished",remaining:"running"===this.state.value?s-(Date.now()-this.state.start):s},t&&e()}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/Timer.cjs"}],[2301,{"@metamask/snaps-rpc-methods":2346,"@metamask/snaps-utils":2516},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.CLIENT_ONLY_HANDLERS=s.METAMASK_ORIGIN=s.STATE_DEBOUNCE_TIMEOUT=s.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS=s.ALLOWED_PERMISSIONS=void 0;const n=t("@metamask/snaps-rpc-methods"),a=t("@metamask/snaps-utils");s.ALLOWED_PERMISSIONS=Object.freeze(["snap_dialog","snap_manageState","snap_notify","snap_getLocale",n.SnapEndowments.Cronjob,n.SnapEndowments.HomePage,n.SnapEndowments.LifecycleHooks,n.SnapEndowments.EthereumProvider,n.SnapEndowments.TransactionInsight,n.SnapEndowments.SignatureInsight]),s.LEGACY_ENCRYPTION_KEY_DERIVATION_OPTIONS={algorithm:"PBKDF2",params:{iterations:1e4}},s.STATE_DEBOUNCE_TIMEOUT=500,s.METAMASK_ORIGIN="metamask",s.CLIENT_ONLY_HANDLERS=Object.freeze([a.HandlerType.OnClientRequest,a.HandlerType.OnSignature,a.HandlerType.OnTransaction,a.HandlerType.OnCronjob,a.HandlerType.OnNameLookup,a.HandlerType.OnHomePage,a.HandlerType.OnSettingsPage,a.HandlerType.OnUserInput,a.HandlerType.OnAssetsLookup,a.HandlerType.OnAssetsConversion,a.HandlerType.OnAssetHistoricalPrice,a.HandlerType.OnAssetsMarketData,a.HandlerType.OnWebSocketEvent])}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/constants.cjs"}],[2302,{"./SnapController.cjs":2299,"./constants.cjs":2301,"./location/index.cjs":2304,"./registry/index.cjs":2308,"./selectors.cjs":2311},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./constants.cjs"),s),a(t("./location/index.cjs"),s),a(t("./SnapController.cjs"),s),a(t("./selectors.cjs"),s),a(t("./registry/index.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/index.cjs"}],[2303,{"@metamask/snaps-utils":2516,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}Object.defineProperty(s,"__esModule",{value:!0}),s.HttpLocation=void 0;const a=t("@metamask/snaps-utils"),i=t("@metamask/utils");s.HttpLocation=class{constructor(t,e={}){n(this,"cache",new Map),n(this,"validatedManifest",void 0),n(this,"url",void 0),n(this,"fetchFn",void 0),n(this,"fetchOptions",void 0),(0,i.assertStruct)(t.toString(),a.HttpSnapIdStruct,"Invalid Snap Id: "),this.fetchFn=e.fetch??globalThis.fetch.bind(undefined),this.fetchOptions=e.fetchOptions,this.url=t}async manifest(){if(this.validatedManifest)return this.validatedManifest.clone();const t=new URL(a.NpmSnapFileNames.Manifest,this.url).toString(),e=await this.fetchFn(t,this.fetchOptions);if(!e.ok)throw new Error(`Failed to fetch "${t}". Status code: ${e.status}.`);const s=await e.text(),n=(0,a.parseJson)(s),i=new a.VirtualFile({value:s,result:(0,a.createSnapManifest)(n),path:a.NpmSnapFileNames.Manifest,data:{canonicalPath:t}});return this.validatedManifest=i,this.manifest()}async fetch(t){const e=(0,a.normalizeRelative)(t),s=this.cache.get(e);if(s!==undefined)return s.clone();const n=this.toCanonical(e).toString(),r=await this.fetchFn(n,this.fetchOptions);if(!r.ok)throw new Error(`Failed to fetch "${n}". Status code: ${r.status}.`);const o=await r.arrayBuffer(),c=new a.VirtualFile({value:new Uint8Array(o),path:e,data:{canonicalPath:n}});return(0,i.assert)(!this.cache.has(e),"Corrupted cache, multiple files with same path."),this.cache.set(e,c),this.fetch(e)}get root(){return new URL(this.url)}toCanonical(t){return(0,i.assert)(!t.startsWith("/"),"Tried to parse absolute path."),new URL(t,this.url)}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/http.cjs"}],[2304,{"./http.cjs":2303,"./local.cjs":2305,"./location.cjs":2306,"./npm.cjs":2307},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./location.cjs"),s),a(t("./npm.cjs"),s),a(t("./local.cjs"),s),a(t("./http.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/index.cjs"}],[2305,{"./http.cjs":2303,"@metamask/snaps-utils":2516,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){(function(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")})(t,e),e.set(t,s)}function a(t,e){return t.get(i(t,e))}function i(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.LocalLocation=void 0;const r=t("@metamask/snaps-utils"),o=t("@metamask/utils"),c=t("./http.cjs");var l=new WeakMap;function u(t){return(0,o.assert)(t.data.canonicalPath!==undefined),t.data.canonicalPath=`local:${t.data.canonicalPath}`,t}s.LocalLocation=class{constructor(t,e={}){var s,a,u;n(this,l,void 0),(0,o.assertStruct)(t.toString(),r.LocalSnapIdStruct,"Invalid Snap Id"),(0,o.assert)(e.fetchOptions===undefined,"Currently adding fetch options to local: is unsupported."),s=l,a=this,u=new c.HttpLocation(new URL(t.toString().slice(r.SnapIdPrefixes.local.length)),{...e,fetchOptions:{cache:"no-cache"}}),s.set(i(s,a),u)}async manifest(){return u(await a(l,this).manifest())}async fetch(t){return u(await a(l,this).fetch(t))}get shouldAlwaysReload(){return!0}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/local.cjs"}],[2306,{"./http.cjs":2303,"./local.cjs":2305,"./npm.cjs":2307,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.detectSnapLocation=void 0;const n=t("@metamask/utils"),a=t("./http.cjs"),i=t("./local.cjs"),r=t("./npm.cjs");s.detectSnapLocation=function(t,e){const s=(null==e?void 0:e.allowHttp)??!1,o=(null==e?void 0:e.allowLocal)??!1,c=new URL(t);switch(c.protocol){case"npm:":return new r.NpmLocation(c,e);case"local:":return(0,n.assert)(o,new TypeError("Fetching local snaps is disabled.")),new i.LocalLocation(c,e);case"http:":case"https:":return(0,n.assert)(s,new TypeError("Fetching snaps through http/https is disabled.")),new a.HttpLocation(c,e);default:throw new TypeError(`Unrecognized "${c.protocol}" snap location protocol.`)}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/location.cjs"}],[2307,{"@metamask/snaps-utils":2516,"@metamask/utils":2632,"concat-stream":2315,"get-npm-tarball-url":3984,"readable-stream":4805,"readable-web-to-node-stream":4806,"tar-stream":2319},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){a(t,e),e.set(t,s)}function a(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function r(t,e,s){return t.set(c(t,e),s),s}function o(t,e){return t.get(c(t,e))}function c(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}var l=function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0}),s.getNpmCanonicalBasePath=s.fetchNpmMetadata=s.NpmLocation=s.TARBALL_SIZE_SAFETY_LIMIT=s.BaseNpmLocation=s.DEFAULT_NPM_REGISTRY=void 0;const u=t("@metamask/snaps-utils"),d=t("@metamask/utils"),h=l(t("concat-stream")),p=l(t("get-npm-tarball-url")),m=t("readable-stream"),f=t("readable-web-to-node-stream"),g=t("tar-stream");s.DEFAULT_NPM_REGISTRY=new URL("https://registry.npmjs.org");var y=new WeakMap,S=new WeakMap,v=new WeakSet;class w{constructor(t,e={}){var r,o;a(r=this,o=v),o.add(r),i(this,"meta",void 0),n(this,y,void 0),n(this,S,void 0);const c=e.allowCustomRegistries??!1,l=e.fetch??globalThis.fetch.bind(undefined),h=e.versionRange??u.DEFAULT_REQUESTED_SNAP_VERSION,p=e.resolveVersion??(async t=>t);let m;(0,d.assertStruct)(t.toString(),u.NpmSnapIdStruct,"Invalid Snap Id: "),""===t.host&&""===t.port&&""===t.username&&""===t.password?m=s.DEFAULT_NPM_REGISTRY:(m="https://",t.username&&(m+=t.username,t.password&&(m+=`:${t.password}`),m+="@"),m+=t.host,m=new URL(m),(0,d.assert)(c,new TypeError(`Custom NPM registries are disabled, tried to use "${m.toString()}".`))),(0,d.assert)("/"===m.pathname&&""===m.search&&""===m.hash),(0,d.assert)(""!==t.pathname&&"/"!==t.pathname,new TypeError("The package name in NPM location is empty."));let f=t.pathname;f.startsWith("/")&&(f=f.slice(1)),this.meta={requestedRange:h,registry:m,packageName:f,fetch:l,resolveVersion:p}}async manifest(){if(o(y,this))return o(y,this).clone();const t=await this.fetch("snap.manifest.json"),e=(0,u.parseJson)(t.toString());return t.result=(0,u.createSnapManifest)(e),r(y,this,t),this.manifest()}async fetch(t){const e=(0,u.normalizeRelative)(t);o(S,this)||(await c(v,this,_).call(this),(0,d.assert)(o(S,this)!==undefined));const s=o(S,this).get(e);return(0,d.assert)(s!==undefined,new TypeError(`File "${t}" not found in package.`)),s.clone()}get packageName(){return this.meta.packageName}get version(){return(0,d.assert)(this.meta.version!==undefined,"Tried to access version without first fetching NPM package."),this.meta.version}get registry(){return this.meta.registry}get versionRange(){return this.meta.requestedRange}}async function _(){(0,d.assert)(o(S,this)===undefined);const t=await this.meta.resolveVersion(this.meta.requestedRange),{tarballURL:e,targetVersion:s}=await async function(t,e,s,n){var a;if(T(s)&&(0,d.isValidSemVerVersion)(e))return{tarballURL:(0,p.default)(t,e),targetVersion:e};const i=await b(t,s,n),r=Object.keys((null==i?void 0:i.versions)??{}).map(t=>((0,d.assertIsSemVerVersion)(t),t)),o=(0,u.getTargetVersion)(r,e);if(null===o)throw new Error(`Failed to find a matching version in npm metadata for package "${t}" and requested semver range "${e}".`);const c=null==i||null===(a=i.versions)||void 0===a||null===(a=a[o])||void 0===a||null===(a=a.dist)||void 0===a?void 0:a.tarball;return{tarballURL:c,targetVersion:o}}(this.meta.packageName,t,this.meta.registry,this.meta.fetch);if(!(0,u.isValidUrl)(e)||!e.toString().endsWith(".tgz"))throw new Error(`Failed to find valid tarball URL in NPM metadata for package "${this.meta.packageName}".`);const n=new URL(e);n.hostname=this.meta.registry.hostname,n.protocol=this.meta.registry.protocol;const a=await this.fetchNpmTarball(n);r(S,this,a),this.meta.version=s}s.BaseNpmLocation=w,s.TARBALL_SIZE_SAFETY_LIMIT=262144e3;async function b(t,e,s){const n=await s(new URL(t,e).toString(),{headers:{accept:T(e)?"application/vnd.npm.install-v1+json; q=1.0, application/json; q=0.8, */*":"application/json"}});if(!n.ok)throw new Error(`Failed to fetch NPM registry entry. Status code: ${n.status}.`);const a=await n.json();if(!(0,d.isObject)(a))throw new Error(`Failed to fetch package "${t}" metadata from npm.`);return a}function E(t,e){let s="npm://";return""!==t.username&&(s+=t.username,""!==t.password&&(s+=`:${t.password}`),s+="@"),`${s}${t.host}/${e}/`}function T(t){return t.toString()===s.DEFAULT_NPM_REGISTRY.toString()}s.NpmLocation=class extends w{async fetchNpmTarball(t){const e=await this.meta.fetch(t.toString());(0,d.assert)(404!==e.status,`"${this.meta.packageName}" was not found in the NPM registry`),(0,d.assert)(e.ok&&e.body,`Failed to fetch tarball for package "${this.meta.packageName}"`);const n=e.headers.get("content-length");(0,d.assert)(n,"Snap tarball has invalid content-length");const a=parseInt(n,10);return(0,d.assert)(a<=s.TARBALL_SIZE_SAFETY_LIMIT,"Snap tarball exceeds size limit"),new Promise((t,n)=>{const a=new Map,i=function(t,e){(0,d.assert)(t.endsWith("/"),"Base needs to end with '/' for relative paths to be added as children instead of siblings."),(0,d.assert)(t.startsWith("npm:"),'Protocol mismatch, expected "npm:".');const n=(0,g.extract)();let a=0;return n.on("entry",(i,r,o)=>{const{name:c,type:l}=i;if("file"===l){const i=c.replace(k,"");return r.pipe((0,h.default)({encoding:"uint8array"},r=>{try{a+=r.byteLength,(0,d.assert)(a<s.TARBALL_SIZE_SAFETY_LIMIT,`Snap tarball exceeds limit of ${s.TARBALL_SIZE_SAFETY_LIMIT} bytes.`);const n=new u.VirtualFile({value:r,path:i,data:{canonicalPath:new URL(i,t).toString()}});return(0,d.assert)(!e.has(i),"Malformed tarball, multiple files with the same path."),e.set(i,n),o()}catch(t){return n.destroy(t)}}))}return r.on("end",()=>o()),r.resume()}),n}(E(this.meta.registry,this.meta.packageName),a),r=e.body,o=new DecompressionStream("gzip"),c=r.pipeThrough(o);(0,m.pipeline)(function(t){if("function"!=typeof t.getReader)return t;return new f.ReadableWebToNodeStream(t)}(c),i,e=>{e?n(e):t(a)})})}},s.fetchNpmMetadata=b,s.getNpmCanonicalBasePath=E;const k=/^package\//u}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/location/npm.cjs"}],[2308,{"./json.cjs":2309,"./registry.cjs":2310},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./registry.cjs"),s),a(t("./json.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/index.cjs"}],[2309,{"./registry.cjs":2310,"@metamask/base-controller":1140,"@metamask/snaps-registry":2325,"@metamask/snaps-utils":2516,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){a(t,e),e.set(t,s)}function a(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(t,e){return t.get(o(t,e))}function r(t,e,s){return t.set(o(t,e),s),s}function o(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.JsonSnapsRegistry=void 0;const c=t("@metamask/base-controller"),l=t("@metamask/snaps-registry"),u=t("@metamask/snaps-utils"),d=t("@metamask/utils"),h=t("./registry.cjs"),p={database:null,lastUpdated:null,databaseUnavailable:!1};var m=new WeakMap,f=new WeakMap,g=new WeakMap,y=new WeakMap,S=new WeakMap,v=new WeakMap,w=new WeakSet;class _ extends c.BaseController{constructor({messenger:t,state:e,url:s={registry:"https://acl.execution.metamask.io/latest/registry.json",signature:"https://acl.execution.metamask.io/latest/signature.json"},publicKey:i="0x025b65308f0f0fb8bc7f7ff87bfc296e0330eee5d3c1d1ee4a048b2fd6a86fa0a6",fetchFunction:c=globalThis.fetch.bind(undefined),recentFetchThreshold:l=(0,d.inMilliseconds)(5,d.Duration.Minute),refetchOnAllowlistMiss:u=!0}){var h,_;super({messenger:t,metadata:{database:{persist:!0,anonymous:!1},lastUpdated:{persist:!0,anonymous:!1},databaseUnavailable:{persist:!0,anonymous:!1}},name:"SnapsRegistry",state:{...p,...e}}),a(h=this,_=w),_.add(h),n(this,m,void 0),n(this,f,void 0),n(this,g,void 0),n(this,y,void 0),n(this,S,void 0),n(this,v,void 0),r(m,this,s),r(f,this,i),r(g,this,c),r(y,this,l),r(S,this,u),r(v,this,null),this.messagingSystem.registerActionHandler("SnapsRegistry:get",async(...t)=>o(w,this,M).call(this,...t)),this.messagingSystem.registerActionHandler("SnapsRegistry:getMetadata",(...t)=>o(w,this,I).call(this,...t)),this.messagingSystem.registerActionHandler("SnapsRegistry:resolveVersion",async(...t)=>o(w,this,A).call(this,...t)),this.messagingSystem.registerActionHandler("SnapsRegistry:update",async()=>o(w,this,E).call(this))}}function b(){return this.state.lastUpdated&&Date.now()-this.state.lastUpdated<i(y,this)}async function E(){i(v,this)?await i(v,this):(null===i(v,this)&&r(v,this,o(w,this,T).call(this)),await i(v,this),r(v,this,null))}async function T(){if(!o(w,this,b).call(this))try{const[t,e]=await Promise.all([o(w,this,R).call(this,i(m,this).registry),o(w,this,R).call(this,i(m,this).signature)]);o(w,this,C).call(this,t,e),this.update(e=>{e.database=JSON.parse(t),e.lastUpdated=Date.now(),e.databaseUnavailable=!1})}catch{this.update(t=>{t.databaseUnavailable=!0})}}async function k(){return null===this.state.database&&await o(w,this,E).call(this),this.state.database}async function P(t,e,s=!1){var n;const a=await o(w,this,k).call(this),r=null==a?void 0:a.blockedSnaps.find(s=>"id"in s?s.id===t&&(0,d.satisfiesVersionRange)(e.version,s.versionRange):s.checksum===e.checksum);if(r)return{status:h.SnapsRegistryStatus.Blocked,reason:r.reason};const c=null==a?void 0:a.verifiedSnaps[t],l=null==c||null===(n=c.versions)||void 0===n?void 0:n[e.version];return l&&l.checksum===e.checksum?{status:h.SnapsRegistryStatus.Verified}:i(S,this)&&!s?(await o(w,this,E).call(this),o(w,this,P).call(this,t,e,!0)):{status:this.state.databaseUnavailable?h.SnapsRegistryStatus.Unavailable:h.SnapsRegistryStatus.Unverified}}async function M(t){return Object.entries(t).reduce(async(t,[e,s])=>{const n=await o(w,this,P).call(this,e,s),a=await t;return a[e]=n,a},Promise.resolve({}))}async function A(t,e,s=!1){var n;const a=await o(w,this,k).call(this),r=(null==a||null===(n=a.verifiedSnaps[t])||void 0===n?void 0:n.versions)??null;if(!r&&i(S,this)&&!s)return await o(w,this,E).call(this),o(w,this,A).call(this,t,e,!0);if(!r)return e;const c=(0,u.getTargetVersion)(Object.keys(r),e);return c||!i(S,this)||s?c?((0,d.assertIsSemVerRange)(c),c):e:(await o(w,this,E).call(this),o(w,this,A).call(this,t,e,!0))}function I(t){var e;return(null===(e=this.state)||void 0===e||null===(e=e.database)||void 0===e||null===(e=e.verifiedSnaps[t])||void 0===e?void 0:e.metadata)??null}function C(t,e){(0,d.assert)(i(f,this),"No public key provided.");const s=(0,l.verify)({registry:t,signature:JSON.parse(e),publicKey:i(f,this)});(0,d.assert)(s,"Invalid registry signature.")}async function R(t){const e=await i(g,this).call(this,t);if(!e.ok)throw new Error(`Failed to fetch ${t}.`);return await e.text()}s.JsonSnapsRegistry=_}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/json.cjs"}],[231,{"../../../../shared/modules/fetch-with-timeout":5358,"../../../../shared/modules/rpc.utils":5367,"./sentinel-api":230,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.RelayStatus=s.RELAY_RPC_METHOD=void 0,s.isRelaySupported=async function(t){return Boolean(await d(t))},s.submitRelayTransaction=async function(t){const{chainId:e}=t,s=await d(e);if(!s)throw new Error(`Chain not supported by transaction relay - ${e}`);c("Request",s,t);const n=await(0,i.jsonRpcRequest)(s,u,[t]);return c("Response",n),n},s.waitForRelayResult=async function(t){const{chainId:e,interval:s,uuid:n}=t,a=await d(e);if(!a)throw new Error(`Chain not supported by transaction relay - ${e}`);const i=`${a}smart-transactions/${n}`;return new Promise((t,e)=>{const n=setInterval(async()=>{try{const e=await async function(t){c("Polling request",t);const e=await(0,r.default)()(t);if(c("Polling response",e),!e.ok){const t=await e.text();throw new Error(`Failed to fetch relay transaction status: ${e.status} - ${t}`)}const s=await e.json(),n=null==s?void 0:s.transactions[0],{hash:a,status:i}=n||{};return{status:i,transactionHash:a}}(i);e.status!==l.Pending&&(clearInterval(n),t(e))}catch(t){clearInterval(n),e(t)}},s)})};var n,a=t("@metamask/utils"),i=t("../../../../shared/modules/rpc.utils"),r=(n=t("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n},o=t("./sentinel-api");const c=(0,a.createProjectLogger)("transaction-relay");let l=s.RelayStatus=function(t){return t.Pending="PENDING",t.Success="VALIDATED",t}({});const u=s.RELAY_RPC_METHOD="eth_sendRelayTransaction";async function d(t){const e=await(0,o.getSentinelNetworkFlags)(t);return null!=e&&e.relayTransactions?(0,o.buildUrl)(e.network):(c("Chain is not supported",t),undefined)}}}},{package:"$root$",file:"app/scripts/lib/transaction/transaction-relay.ts"}],[2310,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n;Object.defineProperty(s,"__esModule",{value:!0}),s.SnapsRegistryStatus=void 0,function(t){t[t.Unverified=0]="Unverified",t[t.Blocked=1]="Blocked",t[t.Verified=2]="Verified",t[t.Unavailable=3]="Unavailable"}(n||(s.SnapsRegistryStatus=n={}))}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/registry/registry.cjs"}],[2311,{},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.getRunnableSnaps=void 0;s.getRunnableSnaps=t=>t.filter(t=>t.enabled&&!t.blocked)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/snaps/selectors.cjs"}],[2312,{"./snaps/Timer.cjs":2300,"@metamask/snaps-sdk":2402,"@metamask/snaps-utils":2516,"fast-deep-equal":3931},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(s,"__esModule",{value:!0}),s.isLocalSnapId=s.isTrackableHandler=s.throttleTracking=s.TRACKABLE_HANDLERS=s.debouncePersistState=s.fetchSnap=s.getSnapFiles=s.withTimeout=s.hasTimedOut=s.delayWithTimer=s.delay=s.permissionsDiff=s.setDiff=void 0;const a=t("@metamask/snaps-sdk"),i=t("@metamask/snaps-utils"),r=n(t("fast-deep-equal")),o=t("./snaps/Timer.cjs");function c(t,e){let s;const n=new Promise((n,a)=>{t.start(()=>{e===undefined?n():n(e)}),s=a});return n.cancel=()=>{"finished"!==t.status&&(t.cancel(),s(new Error("The delay has been canceled.")))},n}async function l(t,e){return e&&0!==e.length?await Promise.all(e.map(async e=>t.fetch(e))):[]}s.setDiff=function(t,e){return Object.entries(t).reduce((t,[s,n])=>(s in e||(t[s]=n),t),{})},s.permissionsDiff=function(t,e){return Object.entries(t).reduce((t,[s,n])=>{const a=s in e;return(!a||a&&!(0,r.default)(n.caveats??[],e[s].caveats??[]))&&(t[s]=n),t},{})},s.delay=function(t,e){return c(new o.Timer(t),e)},s.delayWithTimer=c,s.hasTimedOut=Symbol("Used to check if the requested promise has timeout (see withTimeout)"),s.withTimeout=async function(t,e){const n=c("number"==typeof e?new o.Timer(e):e,s.hasTimedOut);try{return await Promise.race([t,n])}finally{n.cancel()}},s.getSnapFiles=l,s.fetchSnap=async function(t,e){try{const t=await e.manifest(),s=await e.fetch(t.result.source.location.npm.filePath);(0,a.assert)(s.size<i.MAX_FILE_SIZE,"Snap source code must be smaller than 64 MB.");const{iconPath:n}=t.result.source.location.npm,r=n?await e.fetch(n):undefined,o=await l(e,t.result.source.files);(0,i.validateAuxiliaryFiles)(o),await Promise.all(o.map(async t=>{t.data.base64=await(0,i.encodeBase64)(t)}));const c=await l(e,t.result.source.locales),u={manifest:t,sourceCode:s,svgIcon:r,auxiliaryFiles:o,localizationFiles:(0,i.getValidatedLocalizationFiles)(c)};return await(0,i.validateFetchedSnap)(u),u}catch(e){throw new Error(`Failed to fetch snap "${t}": ${(0,a.getErrorMessage)(e)}.`)}},s.debouncePersistState=function(t,e=1e3){const s=new Map;return(n,a,i)=>{const r=`${n}-${i}`;s.has(r)&&clearTimeout(s.get(r)),s.set(r,setTimeout(()=>{t(n,a,i),s.delete(r)},e))}},s.TRACKABLE_HANDLERS=Object.freeze([i.HandlerType.OnHomePage,i.HandlerType.OnInstall,i.HandlerType.OnNameLookup,i.HandlerType.OnRpcRequest,i.HandlerType.OnSignature,i.HandlerType.OnTransaction,i.HandlerType.OnUpdate]),s.throttleTracking=function(t,e=6e4){const s=new Map,n=new Map;return(a,i,r,o)=>{const c=`${a}${i}${r}${o}`,l=Date.now(),u=s.get(c)??0,d=[a,i,r,o];if(l-u>=e)return s.set(c,l),void t(...d);const h=n.get(c);null!=h&&h.timer&&clearTimeout(h.timer),s.set(c,l),n.set(c,{args:d,timer:setTimeout(()=>{t(...d),n.delete(c)},e)})}},s.isTrackableHandler=function(t){return s.TRACKABLE_HANDLERS.includes(t)},s.isLocalSnapId=function(t){return t.startsWith("local:")}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/utils.cjs"}],[2313,{"../snaps/index.cjs":2302,"@metamask/rpc-errors":2224,"@metamask/snaps-utils":2516,"@metamask/utils":2632,nanoid:4546},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){function n(t,e,s){a(t,e),e.set(t,s)}function a(t,e){if(e.has(t))throw new TypeError("Cannot initialize the same private elements twice on an object")}function i(t,e,s){return(e=function(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var s=t[Symbol.toPrimitive];if(void 0!==s){var n=s.call(t,e||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}function r(t,e){return t.get(c(t,e))}function o(t,e,s){return t.set(c(t,e),s),s}function c(t,e,s){if("function"==typeof t?t===e:t.has(e))return arguments.length<3?e:s;throw new TypeError("Private element is not present on this object")}Object.defineProperty(s,"__esModule",{value:!0}),s.WebSocketService=void 0;const l=t("@metamask/rpc-errors"),u=t("@metamask/snaps-utils"),d=t("@metamask/utils"),h=t("nanoid"),p=t("../snaps/index.cjs"),m="WebSocketService";var f=new WeakMap,g=new WeakMap,y=new WeakSet;function S(t,e){const s=r(g,this).get(e);return(0,d.assert)(s&&s.snapId===t,`Socket with ID "${e}" not found.`),s}function v(t,e,s){return c(y,this,k).call(this,t).some(t=>t.url===e&&(0,u.isEqual)(t.protocols,s))}function w(t,e){r(f,this).call("SnapController:handleRequest",{origin:p.METAMASK_ORIGIN,snapId:t,handler:u.HandlerType.OnWebSocketEvent,request:{method:"",params:{event:e}}}).catch(e=>{(0,u.logError)(`An error occurred while handling a WebSocket message for Snap "${t}":`,e)})}async function _(t,e,s=[]){(0,d.assert)(!c(y,this,v).call(this,t,e,s),`An open WebSocket connection to ${e} already exists.`);const n=new URL(e),{origin:a}=n,i=(0,h.nanoid)(),o=new WebSocket(e,s);o.binaryType="arraybuffer";const{promise:u,resolve:p,reject:m}=(0,d.createDeferredPromise)();o.addEventListener("open",()=>{p(),c(y,this,w).call(this,t,{type:"open",id:i,origin:a})}),o.addEventListener("close",e=>{r(g,this).delete(i),c(y,this,w).call(this,t,{type:"close",id:i,origin:a,code:e.code,reason:e.reason,wasClean:e.wasClean??null})});const f=()=>{m(l.rpcErrors.resourceUnavailable("An error occurred while opening the WebSocket."))};return o.addEventListener("error",f),o.addEventListener("message",e=>{const s="string"==typeof e.data?{type:"text",message:e.data}:{type:"binary",message:Array.from(new Uint8Array(e.data))};c(y,this,w).call(this,t,{type:"message",id:i,origin:a,data:s})}),r(g,this).set(i,{id:i,snapId:t,url:e,protocols:s,socket:o,openPromise:u}),await u,o.removeEventListener("error",f),i}function b(t,e){const{socket:s}=c(y,this,S).call(this,t,e);s.close()}function E(t){for(const e of c(y,this,k).call(this,t))c(y,this,b).call(this,t,e.id)}async function T(t,e,s){const{socket:n,openPromise:a}=c(y,this,S).call(this,t,e);await a;const i=Array.isArray(s)?new Uint8Array(s):s;n.send(i)}function k(t){return[...r(g,this).values()].filter(e=>e.snapId===t).map(t=>({id:t.id,url:t.url,protocols:t.protocols}))}s.WebSocketService=class{constructor({messenger:t}){var e,s;a(e=this,s=y),s.add(e),i(this,"name",m),i(this,"state",null),n(this,f,void 0),n(this,g,void 0),o(f,this,t),o(g,this,new Map),r(f,this).registerActionHandler(`${m}:open`,async(...t)=>c(y,this,_).call(this,...t)),r(f,this).registerActionHandler(`${m}:close`,(...t)=>c(y,this,b).call(this,...t)),r(f,this).registerActionHandler(`${m}:sendMessage`,async(...t)=>c(y,this,T).call(this,...t)),r(f,this).registerActionHandler(`${m}:getAll`,(...t)=>c(y,this,k).call(this,...t)),r(f,this).subscribe("SnapController:snapUpdated",t=>{c(y,this,E).call(this,t.id)}),r(f,this).subscribe("SnapController:snapUninstalled",t=>{c(y,this,E).call(this,t.id)}),r(f,this).subscribe("SnapController:snapInstalled",t=>{c(y,this,E).call(this,t.id)})}}}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/websocket/WebSocketService.cjs"}],[2314,{"./WebSocketService.cjs":2313},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]},a=function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),a(t("./WebSocketService.cjs"),s)}}},{package:"@metamask/snaps-controllers",file:"node_modules/@metamask/snaps-controllers/dist/websocket/index.cjs"}],[2315,{buffer:3590,"buffer-from":3596,inherits:4158,"readable-stream":4805,typedarray:5152},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){(function(s){(function(){var n=t("readable-stream").Writable,a=t("inherits"),i=t("buffer-from");if("undefined"==typeof Uint8Array)var r=t("typedarray").Uint8Array;else r=Uint8Array;function o(t,e){if(!(this instanceof o))return new o(t,e);"function"==typeof t&&(e=t,t={}),t||(t={});var s=t.encoding,a=!1;s?"u8"!==(s=String(s).toLowerCase())&&"uint8"!==s||(s="uint8array"):a=!0,n.call(this,{objectMode:!0}),this.encoding=s,this.shouldInferEncoding=a,e&&this.on("finish",function(){e(this.getBody())}),this.body=[]}e.exports=o,a(o,n),o.prototype._write=function(t,e,s){this.body.push(t),s()},o.prototype.inferEncoding=function(t){var e=t===undefined?this.body[0]:t;return s.isBuffer(e)?"buffer":"undefined"!=typeof Uint8Array&&e instanceof Uint8Array?"uint8array":Array.isArray(e)?"array":"string"==typeof e?"string":"[object Object]"===Object.prototype.toString.call(e)?"object":"buffer"},o.prototype.getBody=function(){return this.encoding||0!==this.body.length?(this.shouldInferEncoding&&(this.encoding=this.inferEncoding()),"array"===this.encoding?function(t){for(var e=[],s=0;s<t.length;s++)e.push.apply(e,t[s]);return e}(this.body):"string"===this.encoding?function(t){for(var e=[],n=0;n<t.length;n++){var a=t[n];"string"==typeof a||s.isBuffer(a)?e.push(a):c(a)?e.push(i(a)):e.push(i(String(a)))}e=s.isBuffer(t[0])?(e=s.concat(e)).toString("utf8"):e.join("");return e}(this.body):"buffer"===this.encoding?function(t){for(var e=[],n=0;n<t.length;n++){var a=t[n];s.isBuffer(a)?e.push(a):c(a)?e.push(i(a)):e.push(i(String(a)))}return s.concat(e)}(this.body):"uint8array"===this.encoding?function(t){for(var e=0,s=0;s<t.length;s++)"string"==typeof t[s]&&(t[s]=i(t[s])),e+=t[s].length;for(var n=new r(e),a=(s=0,0);s<t.length;s++)for(var o=t[s],c=0;c<o.length;c++)n[a++]=o[c];return n}(this.body):this.body):[]};Array.isArray;function c(t){return"string"==typeof t||(e=t,/Array\]$/.test(Object.prototype.toString.call(e)))||t&&"function"==typeof t.subarray;var e}}).call(this)}).call(this,t("buffer").Buffer)}}},{package:"@metamask/snaps-controllers>concat-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/concat-stream/index.js"}],[2316,{fs:3542},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){const n={S_IFMT:61440,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960};try{e.exports=t("fs").constants||n}catch{e.exports=n}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/constants.js"}],[2317,{"./headers":2318,b4a:3470,"fast-fifo":3933,streamx:5129},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){const{Writable:n,Readable:a,getStreamError:i}=t("streamx"),r=t("fast-fifo"),o=t("b4a"),c=t("./headers"),l=o.alloc(0);class u{constructor(){this.buffered=0,this.shifted=0,this.queue=new r,this._offset=0}push(t){this.buffered+=t.byteLength,this.queue.push(t)}shiftFirst(t){return 0===this._buffered?null:this._next(t)}shift(t){if(t>this.buffered)return null;if(0===t)return l;let e=this._next(t);if(t===e.byteLength)return e;const s=[e];for(;(t-=e.byteLength)>0;)e=this._next(t),s.push(e);return o.concat(s)}_next(t){const e=this.queue.peek(),s=e.byteLength-this._offset;if(t>=s){const t=this._offset?e.subarray(this._offset,e.byteLength):e;return this.queue.shift(),this._offset=0,this.buffered-=s,this.shifted+=s,t}return this.buffered-=t,this.shifted+=t,e.subarray(this._offset,this._offset+=t)}}class d extends a{constructor(t,e,s){super(),this.header=e,this.offset=s,this._parent=t}_read(t){0===this.header.size&&this.push(null),this._parent._stream===this&&this._parent._update(),t(null)}_predestroy(){this._parent.destroy(i(this))}_detach(){this._parent._stream===this&&(this._parent._stream=null,this._parent._missing=m(this.header.size),this._parent._update())}_destroy(t){this._detach(),t(null)}}class h extends n{constructor(t){super(t),t||(t={}),this._buffer=new u,this._offset=0,this._header=null,this._stream=null,this._missing=0,this._longHeader=!1,this._callback=p,this._locked=!1,this._finished=!1,this._pax=null,this._paxGlobal=null,this._gnuLongPath=null,this._gnuLongLinkPath=null,this._filenameEncoding=t.filenameEncoding||"utf-8",this._allowUnknownFormat=!!t.allowUnknownFormat,this._unlockBound=this._unlock.bind(this)}_unlock(t){if(this._locked=!1,t)return this.destroy(t),void this._continueWrite(t);this._update()}_consumeHeader(){if(this._locked)return!1;this._offset=this._buffer.shifted;try{this._header=c.decode(this._buffer.shift(512),this._filenameEncoding,this._allowUnknownFormat)}catch(t){return this._continueWrite(t),!1}if(!this._header)return!0;switch(this._header.type){case"gnu-long-path":case"gnu-long-link-path":case"pax-global-header":case"pax-header":return this._longHeader=!0,this._missing=this._header.size,!0}return this._locked=!0,this._applyLongHeaders(),0===this._header.size||"directory"===this._header.type?(this.emit("entry",this._header,this._createStream(),this._unlockBound),!0):(this._stream=this._createStream(),this._missing=this._header.size,this.emit("entry",this._header,this._stream,this._unlockBound),!0)}_applyLongHeaders(){this._gnuLongPath&&(this._header.name=this._gnuLongPath,this._gnuLongPath=null),this._gnuLongLinkPath&&(this._header.linkname=this._gnuLongLinkPath,this._gnuLongLinkPath=null),this._pax&&(this._pax.path&&(this._header.name=this._pax.path),this._pax.linkpath&&(this._header.linkname=this._pax.linkpath),this._pax.size&&(this._header.size=parseInt(this._pax.size,10)),this._header.pax=this._pax,this._pax=null)}_decodeLongHeader(t){switch(this._header.type){case"gnu-long-path":this._gnuLongPath=c.decodeLongPath(t,this._filenameEncoding);break;case"gnu-long-link-path":this._gnuLongLinkPath=c.decodeLongPath(t,this._filenameEncoding);break;case"pax-global-header":this._paxGlobal=c.decodePax(t);break;case"pax-header":this._pax=null===this._paxGlobal?c.decodePax(t):Object.assign({},this._paxGlobal,c.decodePax(t))}}_consumeLongHeader(){this._longHeader=!1,this._missing=m(this._header.size);const t=this._buffer.shift(this._header.size);try{this._decodeLongHeader(t)}catch(t){return this._continueWrite(t),!1}return!0}_consumeStream(){const t=this._buffer.shiftFirst(this._missing);if(null===t)return!1;this._missing-=t.byteLength;const e=this._stream.push(t);return 0===this._missing?(this._stream.push(null),e&&this._stream._detach(),e&&!1===this._locked):e}_createStream(){return new d(this,this._header,this._offset)}_update(){for(;this._buffer.buffered>0&&!this.destroying;){if(this._missing>0){if(null!==this._stream){if(!1===this._consumeStream())return;continue}if(!0===this._longHeader){if(this._missing>this._buffer.buffered)break;if(!1===this._consumeLongHeader())return!1;continue}const t=this._buffer.shiftFirst(this._missing);null!==t&&(this._missing-=t.byteLength);continue}if(this._buffer.buffered<512)break;if(null!==this._stream||!1===this._consumeHeader())return}this._continueWrite(null)}_continueWrite(t){const e=this._callback;this._callback=p,e(t)}_write(t,e){this._callback=e,this._buffer.push(t),this._update()}_final(t){this._finished=0===this._missing&&0===this._buffer.buffered,t(this._finished?null:new Error("Unexpected end of data"))}_predestroy(){this._continueWrite(null)}_destroy(t){this._stream&&this._stream.destroy(i(this)),t(null)}[Symbol.asyncIterator](){let t=null,e=null,s=null,n=null,a=null;const i=this;return this.on("entry",function(t,i,r){a=r,i.on("error",p),e?(e({value:i,done:!1}),e=s=null):n=i}),this.on("error",e=>{t=e}),this.on("close",function(){if(r(t),!e)return;t?s(t):e({value:undefined,done:!0});e=s=null}),{[Symbol.asyncIterator](){return this},next:()=>new Promise(o),return:()=>c(null),throw:t=>c(t)};function r(t){if(!a)return;const e=a;a=null,e(t)}function o(a,o){return t?o(t):n?(a({value:n,done:!1}),void(n=null)):(e=a,s=o,r(null),void(i._finished&&e&&(e({value:undefined,done:!0}),e=s=null)))}function c(t){return i.destroy(t),r(t),new Promise((e,s)=>{if(i.destroyed)return e({value:undefined,done:!0});i.once("close",function(){t?s(t):e({value:undefined,done:!0})})})}}}function p(){}function m(t){return(t&=511)&&512-t}e.exports=function(t){return new h(t)}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/extract.js"}],[2318,{b4a:3470},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){const n=t("b4a"),a="0".charCodeAt(0),i=n.from([117,115,116,97,114,0]),r=n.from([a,a]),o=n.from([117,115,116,97,114,32]),c=n.from([32,0]),l=257,u=263;function d(t,e,s,n){for(;s<n;s++)if(t[s]===e)return s;return n}function h(t){let e=256;for(let s=0;s<148;s++)e+=t[s];for(let s=156;s<512;s++)e+=t[s];return e}function p(t,e){return(t=t.toString(8)).length>e?"7777777777777777777".slice(0,e)+" ":"0000000000000000000".slice(0,e-t.length)+t+" "}function m(t,e,s){if(128&(t=t.subarray(e,e+s))[e=0])return function(t){let e;if(128===t[0])e=!0;else{if(255!==t[0])return null;e=!1}const s=[];let n;for(n=t.length-1;n>0;n--){const a=t[n];e?s.push(a):s.push(255-a)}let a=0;const i=s.length;for(n=0;n<i;n++)a+=s[n]*Math.pow(256,n);return e?a:-1*a}(t);{for(;e<t.length&&32===t[e];)e++;const s=(a=d(t,32,e,t.length),i=t.length,r=t.length,"number"!=typeof a?r:(a=~~a)>=i?i:a>=0||(a+=i)>=0?a:0);for(;e<s&&0===t[e];)e++;return s===e?0:parseInt(n.toString(t.subarray(e,s)),8)}var a,i,r}function f(t,e,s,a){return n.toString(t.subarray(e,d(t,0,e,e+s)),a)}function g(t){const e=n.byteLength(t);let s=Math.floor(Math.log(e)/Math.log(10))+1;return e+s>=Math.pow(10,s)&&s++,e+s+t}s.decodeLongPath=function(t,e){return f(t,0,t.length,e)},s.encodePax=function(t){let e="";t.name&&(e+=g(" path="+t.name+"\n")),t.linkname&&(e+=g(" linkpath="+t.linkname+"\n"));const s=t.pax;if(s)for(const t in s)e+=g(" "+t+"="+s[t]+"\n");return n.from(e)},s.decodePax=function(t){const e={};for(;t.length;){let s=0;for(;s<t.length&&32!==t[s];)s++;const a=parseInt(n.toString(t.subarray(0,s)),10);if(!a)return e;const i=n.toString(t.subarray(s+1,a-1)),r=i.indexOf("=");if(-1===r)return e;e[i.slice(0,r)]=i.slice(r+1),t=t.subarray(a)}return e},s.encode=function(t){const e=n.alloc(512);let s=t.name,o="";if(5===t.typeflag&&"/"!==s[s.length-1]&&(s+="/"),n.byteLength(s)!==s.length)return null;for(;n.byteLength(s)>100;){const t=s.indexOf("/");if(-1===t)return null;o+=o?"/"+s.slice(0,t):s.slice(0,t),s=s.slice(t+1)}return n.byteLength(s)>100||n.byteLength(o)>155||t.linkname&&n.byteLength(t.linkname)>100?null:(n.write(e,s),n.write(e,p(4095&t.mode,6),100),n.write(e,p(t.uid,6),108),n.write(e,p(t.gid,6),116),function(t,e,s){t.toString(8).length>11?function(t,e,s){e[s]=128;for(let n=11;n>0;n--)e[s+n]=255&t,t=Math.floor(t/256)}(t,e,s):n.write(e,p(t,11),s)}(t.size,e,124),n.write(e,p(t.mtime.getTime()/1e3|0,11),136),e[156]=a+function(t){switch(t){case"file":return 0;case"link":return 1;case"symlink":return 2;case"character-device":return 3;case"block-device":return 4;case"directory":return 5;case"fifo":return 6;case"contiguous-file":return 7;case"pax-header":return 72}return 0}(t.type),t.linkname&&n.write(e,t.linkname,157),n.copy(i,e,l),n.copy(r,e,263),t.uname&&n.write(e,t.uname,265),t.gname&&n.write(e,t.gname,297),n.write(e,p(t.devmajor||0,6),329),n.write(e,p(t.devminor||0,6),337),o&&n.write(e,o,345),n.write(e,p(h(e),6),148),e)},s.decode=function(t,e,s){let r=0===t[156]?0:t[156]-a,d=f(t,0,100,e);const p=m(t,100,8),g=m(t,108,8),y=m(t,116,8),S=m(t,124,12),v=m(t,136,12),w=function(t){switch(t){case 0:return"file";case 1:return"link";case 2:return"symlink";case 3:return"character-device";case 4:return"block-device";case 5:return"directory";case 6:return"fifo";case 7:return"contiguous-file";case 72:return"pax-header";case 55:return"pax-global-header";case 27:return"gnu-long-link-path";case 28:case 30:return"gnu-long-path"}return null}(r),_=0===t[157]?null:f(t,157,100,e),b=f(t,265,32),E=f(t,297,32),T=m(t,329,8),k=m(t,337,8),P=h(t);if(256===P)return null;if(P!==m(t,148,8))throw new Error("Invalid tar header. Maybe the tar is corrupted or it needs to be gunzipped?");if(function(t){return n.equals(i,t.subarray(l,263))}(t))t[345]&&(d=f(t,345,155,e)+"/"+d);else if(function(t){return n.equals(o,t.subarray(l,263))&&n.equals(c,t.subarray(u,265))}(t));else if(!s)throw new Error("Invalid tar header: unknown format.");return 0===r&&d&&"/"===d[d.length-1]&&(r=5),{name:d,mode:p,uid:g,gid:y,size:S,mtime:new Date(1e3*v),type:w,linkname:_,uname:b,gname:E,devmajor:T,devminor:k,pax:null}}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/headers.js"}],[2319,{"./extract":2317,"./pack":2320},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){s.extract=t("./extract"),s.pack=t("./pack")}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/index.js"}],[232,{"../../../../shared/constants/app":5244,"../../../../shared/constants/security-provider":5269,"../../../../shared/lib/trace":5342,"../ppom/ppom-util":177,"../trust-signals/security-alerts-api":233,"../trust-signals/trust-signals-util":235,"@metamask/keyring-api":1914,"ethereumjs-util":3849},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.addDappTransaction=async function(t){const{dappRequest:e}=t,{id:s,method:n,origin:a}=e,{securityAlertResponse:i,traceContext:r}=e,c={actionId:s,method:n,origin:a,requireApproval:!0,securityAlertResponse:i};(0,o.endTrace)({name:o.TraceName.Middleware,id:s});const{waitForHash:l}=await d({...t,transactionOptions:{...c,traceContext:r}}),u=await l();return(0,o.endTrace)({name:o.TraceName.Transaction,id:s}),u},s.addTransaction=async function(t){await async function(t){const{chainId:e,ppomController:s,securityAlertsEnabled:n,transactionOptions:a,transactionParams:o,updateSecurityAlertResponse:d,internalAccounts:h,getSecurityAlertsConfig:p}=t;!function(t){const{getSecurityAlertResponse:e,addSecurityAlertResponse:s,securityAlertsEnabled:n,transactionOptions:a,transactionParams:i,chainId:r}=t,{origin:o}=a;if(o!==c.ORIGIN_METAMASK||!n)return;const{to:d}=i;if("string"!=typeof d)return;const h=(0,u.mapChainIdToSupportedEVMChain)(r);if(!h)return;(0,l.scanAddressAndAddToCache)(d,e,s,h).catch(t=>{console.error("[scanAddressForTrustSignals] error scanning address for trust signals:",t)})}(t);const{type:m}=a,f=r.SECURITY_PROVIDER_EXCLUDED_TRANSACTION_TYPES.includes(m);if(!n||f)return;if(h.some(({address:t})=>{var e;return t.toLowerCase()===(null===(e=o.to)||void 0===e?void 0:e.toLowerCase())}))return;try{const{from:n,to:c,value:l,data:u}=o,{actionId:h,origin:m}=a,f={method:"eth_sendTransaction",id:h??"",origin:m??"",params:[{from:n,to:c??"",value:l??"",data:u??""}],jsonrpc:"2.0"},g=(0,i.generateSecurityAlertId)();(0,i.validateRequestWithPPOM)({ppomController:s,request:f,securityAlertId:g,chainId:e,updateSecurityAlertResponse:d,getSecurityAlertsConfig:p});const y={...r.LOADING_SECURITY_ALERT_RESPONSE,securityAlertId:g};t.transactionOptions.securityAlertResponse=y}catch(t){(0,i.handlePPOMError)(t,"Error validating JSON RPC using PPOM: ")}}(t);const{transactionMeta:e,waitForHash:s}=await d(t);if(!t.waitForSubmit)return s().catch(()=>{}),e;const n=await s();return function(t,e){return e.state.transactions.find(e=>e.hash===t)}(n,t.transactionController)},s.getTransactionById=h;var n=t("@metamask/keyring-api"),a=t("ethereumjs-util"),i=t("../ppom/ppom-util"),r=t("../../../../shared/constants/security-provider"),o=t("../../../../shared/lib/trace"),c=t("../../../../shared/constants/app"),l=t("../trust-signals/security-alerts-api"),u=t("../trust-signals/trust-signals-util");async function d(t){const{selectedAccount:e}=t;return e.type===n.EthAccountType.Erc4337?async function(t){var e;const{networkClientId:s,transactionController:n,transactionOptions:i,transactionParams:r,userOperationController:o}=t,{maxFeePerGas:c,maxPriorityFeePerGas:l}=r,{origin:u,requireApproval:d,type:p}=i,m={...r,maxFeePerGas:(0,a.addHexPrefix)(c),maxPriorityFeePerGas:(0,a.addHexPrefix)(l)},f=null==i||null===(e=i.swaps)||void 0===e?void 0:e.meta;null!=f&&f.type&&delete f.type;const g={networkClientId:s,origin:u,requireApproval:d,swaps:f,type:p},y=await o.addUserOperationFromTransaction(m,g);o.startPollingByNetworkClientId(s);return{transactionMeta:h(y.id,n),waitForHash:y.transactionHash}}(t):async function(t){const{transactionController:e,transactionOptions:s,transactionParams:n,networkClientId:a}=t,{result:i,transactionMeta:r}=await e.addTransaction(n,{...s,networkClientId:a});return{transactionMeta:r,waitForHash:()=>i}}(t)}function h(t,e){return e.state.transactions.find(e=>e.id===t)}}}},{package:"$root$",file:"app/scripts/lib/transaction/util.ts"}],[2320,{"./constants":2316,"./headers":2318,b4a:3470,streamx:5129},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){const{Readable:n,Writable:a,getStreamError:i}=t("streamx"),r=t("b4a"),o=t("./constants"),c=t("./headers"),l=r.alloc(1024);class u extends a{constructor(t,e,s){super({mapWritable:m,eagerOpen:!0}),this.written=0,this.header=e,this._callback=s,this._linkname=null,this._isLinkname="symlink"===e.type&&!e.linkname,this._isVoid="file"!==e.type&&"contiguous-file"!==e.type,this._finished=!1,this._pack=t,this._openCallback=null,null===this._pack._stream?this._pack._stream=this:this._pack._pending.push(this)}_open(t){this._openCallback=t,this._pack._stream===this&&this._continueOpen()}_continuePack(t){if(null===this._callback)return;const e=this._callback;this._callback=null,e(t)}_continueOpen(){null===this._pack._stream&&(this._pack._stream=this);const t=this._openCallback;if(this._openCallback=null,null!==t){if(this._pack.destroying)return t(new Error("pack stream destroyed"));if(this._pack._finalized)return t(new Error("pack stream is already finalized"));this._pack._stream=this,this._isLinkname||this._pack._encode(this.header),this._isVoid&&(this._finish(),this._continuePack(null)),t(null)}}_write(t,e){return this._isLinkname?(this._linkname=this._linkname?r.concat([this._linkname,t]):t,e(null)):this._isVoid?t.byteLength>0?e(new Error("No body allowed for this entry")):e():(this.written+=t.byteLength,this._pack.push(t)?e():void(this._pack._drain=e))}_finish(){this._finished||(this._finished=!0,this._isLinkname&&(this.header.linkname=this._linkname?r.toString(this._linkname,"utf-8"):"",this._pack._encode(this.header)),p(this._pack,this.header.size),this._pack._done(this))}_final(t){if(this.written!==this.header.size)return t(new Error("Size mismatch"));this._finish(),t(null)}_getError(){return i(this)||new Error("tar entry destroyed")}_predestroy(){this._pack.destroy(this._getError())}_destroy(t){this._pack._done(this),this._continuePack(this._finished?null:this._getError()),t()}}class d extends n{constructor(t){super(t),this._drain=h,this._finalized=!1,this._finalizing=!1,this._pending=[],this._stream=null}entry(t,e,s){if(this._finalized||this.destroying)throw new Error("already finalized or destroyed");"function"==typeof e&&(s=e,e=null),s||(s=h),t.size&&"symlink"!==t.type||(t.size=0),t.type||(t.type=function(t){switch(t&o.S_IFMT){case o.S_IFBLK:return"block-device";case o.S_IFCHR:return"character-device";case o.S_IFDIR:return"directory";case o.S_IFIFO:return"fifo";case o.S_IFLNK:return"symlink"}return"file"}(t.mode)),t.mode||(t.mode="directory"===t.type?493:420),t.uid||(t.uid=0),t.gid||(t.gid=0),t.mtime||(t.mtime=new Date),"string"==typeof e&&(e=r.from(e));const n=new u(this,t,s);return r.isBuffer(e)?(t.size=e.byteLength,n.write(e),n.end(),n):(n._isVoid,n)}finalize(){this._stream||this._pending.length>0?this._finalizing=!0:this._finalized||(this._finalized=!0,this.push(l),this.push(null))}_done(t){t===this._stream&&(this._stream=null,this._finalizing&&this.finalize(),this._pending.length&&this._pending.shift()._continueOpen())}_encode(t){if(!t.pax){const e=c.encode(t);if(e)return void this.push(e)}this._encodePax(t)}_encodePax(t){const e=c.encodePax({name:t.name,linkname:t.linkname,pax:t.pax}),s={name:"PaxHeader",mode:t.mode,uid:t.uid,gid:t.gid,size:e.byteLength,mtime:t.mtime,type:"pax-header",linkname:t.linkname&&"PaxHeader",uname:t.uname,gname:t.gname,devmajor:t.devmajor,devminor:t.devminor};this.push(c.encode(s)),this.push(e),p(this,e.byteLength),s.size=t.size,s.type=t.type,this.push(c.encode(s))}_doDrain(){const t=this._drain;this._drain=h,t()}_predestroy(){const t=i(this);for(this._stream&&this._stream.destroy(t);this._pending.length;){const e=this._pending.shift();e.destroy(t),e._continueOpen()}this._doDrain()}_read(t){this._doDrain(),t()}}function h(){}function p(t,e){(e&=511)&&t.push(l.subarray(0,512-e))}function m(t){return r.isBuffer(t)?t:r.from(t)}e.exports=function(t){return new d(t)}}}},{package:"@metamask/snaps-controllers>tar-stream",file:"node_modules/@metamask/snaps-controllers/node_modules/tar-stream/pack.js"}],[2325,{"./verify":2326,"@metamask/superstruct":2538,"@metamask/utils":2632},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){var n=this&&this.__createBinding||(Object.create?function(t,e,s,n){n===undefined&&(n=s);var a=Object.getOwnPropertyDescriptor(e,s);a&&!("get"in a?!e.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return e[s]}}),Object.defineProperty(t,n,a)}:function(t,e,s,n){n===undefined&&(n=s),t[n]=e[s]}),a=this&&this.__exportStar||function(t,e){for(var s in t)"default"===s||Object.prototype.hasOwnProperty.call(e,s)||n(e,t,s)};Object.defineProperty(s,"__esModule",{value:!0}),s.SnapsRegistryDatabaseStruct=s.BlockedSnapStruct=s.BlockReasonStruct=s.VerifiedSnapStruct=s.ImagePathStruct=s.AdditionalSourceCodeStruct=s.SupportStruct=s.AuditStruct=s.AuthorStruct=void 0;const i=t("@metamask/superstruct"),r=t("@metamask/utils"),o=(0,i.refine)((0,i.string)(),"Npm ID",t=>t.startsWith("npm:")),c=(0,i.object)({checksum:r.ChecksumStruct});s.AuthorStruct=(0,i.object)({name:(0,i.string)(),website:(0,i.string)()}),s.AuditStruct=(0,i.object)({auditor:(0,i.string)(),report:(0,i.string)()}),s.SupportStruct=(0,i.object)({knowledgeBase:(0,i.optional)((0,i.string)()),faq:(0,i.optional)((0,i.string)()),contact:(0,i.optional)((0,i.string)()),keyRecovery:(0,i.optional)((0,i.string)())}),s.AdditionalSourceCodeStruct=(0,i.object)({name:(0,i.string)(),url:(0,i.string)()}),s.ImagePathStruct=(0,i.pattern)((0,i.string)(),/\.\/images\/.*\/\d+\.(?:png|jpe?g)$/u),s.VerifiedSnapStruct=(0,i.object)({id:o,metadata:(0,i.object)({name:(0,i.string)(),type:(0,i.optional)((0,i.enums)(["account"])),author:(0,i.optional)(s.AuthorStruct),website:(0,i.optional)((0,i.string)()),onboard:(0,i.optional)((0,i.boolean)()),summary:(0,i.optional)((0,i.string)()),description:(0,i.optional)((0,i.string)()),audits:(0,i.optional)((0,i.array)(s.AuditStruct)),category:(0,i.optional)((0,i.enums)(["interoperability","notifications","transaction insights","account management","name resolution"])),tags:(0,i.optional)((0,i.array)((0,i.string)())),support:(0,i.optional)(s.SupportStruct),sourceCode:(0,i.optional)((0,i.string)()),hidden:(0,i.optional)((0,i.boolean)()),privateCode:(0,i.optional)((0,i.boolean)()),privacyPolicy:(0,i.optional)((0,i.string)()),termsOfUse:(0,i.optional)((0,i.string)()),additionalSourceCode:(0,i.optional)((0,i.array)(s.AdditionalSourceCodeStruct)),screenshots:(0,i.optional)((0,i.size)((0,i.array)(s.ImagePathStruct),3,3))}),versions:(0,i.record)(r.VersionStruct,c)}),s.BlockReasonStruct=(0,i.object)({explanation:(0,i.optional)((0,i.string)()),url:(0,i.optional)((0,i.string)())}),s.BlockedSnapStruct=(0,i.union)([(0,i.object)({id:o,versionRange:r.VersionRangeStruct,reason:(0,i.optional)(s.BlockReasonStruct)}),(0,i.object)({checksum:r.ChecksumStruct,reason:(0,i.optional)(s.BlockReasonStruct)})]),s.SnapsRegistryDatabaseStruct=(0,i.object)({verifiedSnaps:(0,i.record)(o,s.VerifiedSnapStruct),blockedSnaps:(0,i.array)(s.BlockedSnapStruct)}),a(t("./verify"),s)}}},{package:"@metamask/snaps-utils>@metamask/snaps-registry",file:"node_modules/@metamask/snaps-registry/dist/index.js"}],[2326,{"@metamask/superstruct":2538,"@metamask/utils":2632,"@noble/curves/secp256k1":2673,"@noble/hashes/sha256":2685},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.verify=s.SignatureStruct=void 0;const n=t("@metamask/superstruct"),a=t("@metamask/utils"),i=t("@noble/curves/secp256k1"),r=t("@noble/hashes/sha256");s.SignatureStruct=(0,n.object)({signature:a.StrictHexStruct,curve:(0,n.literal)("secp256k1"),format:(0,n.literal)("DER")}),s.verify=function({registry:t,signature:e,publicKey:n}){(0,a.assertStruct)(e,s.SignatureStruct,"Invalid signature object");const o=(0,a.hexToBytes)(n);return i.secp256k1.verify((0,a.remove0x)(e.signature),(0,r.sha256)((0,a.stringToBytes)(t)),o)}}}},{package:"@metamask/snaps-utils>@metamask/snaps-registry",file:"node_modules/@metamask/snaps-registry/dist/verify.js"}],[233,{"../../../../shared/constants/time":5277,"../../../../shared/modules/fetch-with-timeout":5358,"./types":236},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.scanAddress=l,s.scanAddressAndAddToCache=async function(t,e,s,n){const a=e(t);if(a)return a;const i={result_type:r.ResultType.Loading,label:""};s(t,i);try{const e=await l(n,t);return s(t,e),e}catch(e){throw s(t,{result_type:r.ResultType.ErrorResult,label:""}),e}};var n,a=t("../../../../shared/constants/time"),i=(n=t("../../../../shared/modules/fetch-with-timeout"))&&n.__esModule?n:{default:n},r=t("./types");const o=5*a.SECOND,c="address/evm/scan";async function l(t,e){const s="https://security-alerts.api.cx.metamask.io";const n=`${s}/${c}`,a={chain:t,address:e},r=await(0,i.default)(o)(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await r.json()}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/security-alerts-api.ts"}],[234,{"../../../../shared/modules/transaction.utils":5377,"../ppom/security-alerts-api":179,"./security-alerts-api":233,"./trust-signals-util":235},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.createTrustSignalsMiddleware=function(t,e,s,c,l){return async(u,d,h)=>{try{if(!(0,r.isSecurityAlertsEnabledByUser)(c)||!(0,a.isSecurityAlertsAPIEnabled)())return;(0,r.isEthSendTransaction)(u)?(!function(t,e,s){if(!(0,r.hasValidTransactionParams)(t))return;const{to:n}=t.params[0];let a;try{a=(0,r.getChainId)(s)}catch(t){return void console.error("[createTrustSignalsMiddleware] error getting chainId:",t)}if(!a)return;(0,i.scanAddressAndAddToCache)(n,e.getAddressSecurityAlertResponse,e.addAddressSecurityAlertResponse,a).catch(t=>{console.error("[createTrustSignalsMiddleware] error scanning address for transaction:",t)})}(u,e,t),o(u,s)):(0,r.isEthSignTypedData)(u)?(!function(t,e,s){var a;if(!(0,r.hasValidTypedDataParams)(t))return;const o=(0,n.parseTypedDataMessage)("string"==typeof t.params[1]?t.params[1]:JSON.stringify(t.params[1])),c=null===(a=o.domain)||void 0===a?void 0:a.verifyingContract;if(!c)return;let l;try{l=(0,r.getChainId)(s)}catch(t){return void console.error("[createTrustSignalsMiddleware] error getting chainId:",t)}if(!l)return;(0,i.scanAddressAndAddToCache)(c,e.getAddressSecurityAlertResponse,e.addAddressSecurityAlertResponse,l).catch(t=>{console.error("[createTrustSignalsMiddleware] error scanning address for signature:",t)})}(u,e,t),o(u,s)):((0,r.isConnected)(u,l)||(0,r.connectScreenHasBeenPrompted)(u))&&o(u,s)}catch(t){console.error("[createTrustSignalsMiddleware] error: ",t)}finally{h()}}};var n=t("../../../../shared/modules/transaction.utils"),a=t("../ppom/security-alerts-api"),i=t("./security-alerts-api"),r=t("./trust-signals-util");function o(t,e){t.origin&&e.scanUrl(t.origin).catch(t=>{console.error("[createTrustSignalsMiddleware] error:",t)})}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-middleware.ts"}],[235,{"../../../../shared/constants/app":5244,"../../../../shared/constants/network":5262,"../../../../shared/modules/selectors/networks":5371,"./types":236},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(t,e,s){Object.defineProperty(s,"__esModule",{value:!0}),s.connectScreenHasBeenPrompted=function(t){return t.method===i.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS||t.method===i.MESSAGE_TYPE.WALLET_REQUEST_PERMISSIONS},s.getChainId=function(t){var e;const s=null===(e=(0,a.getProviderConfig)({metamask:t.state}))||void 0===e?void 0:e.chainId;if(!s)throw new Error("Chain ID not found");return c(s)},s.hasValidTransactionParams=function(t){if(!("params"in t)||!t.params)return!1;if(!Array.isArray(t.params)||0===t.params.length)return!1;const e=t.params[0];return"object"==typeof e&&null!==e&&"to"in e},s.hasValidTypedDataParams=function(t){if(!("params"in t)||!t.params)return!1;if(!Array.isArray(t.params)||t.params.length<2)return!1;return t.params[1]!==undefined&&null!==t.params[1]},s.isConnected=function(t,e){if(!t.origin||t.method!==i.MESSAGE_TYPE.ETH_ACCOUNTS)return!1;const s=e(t.origin);return Array.isArray(s)&&s.length>0},s.isEthSendTransaction=function(t){return t.method===i.MESSAGE_TYPE.ETH_SEND_TRANSACTION},s.isEthSignTypedData=function(t){return t.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA||t.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V1||t.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V3||t.method===i.MESSAGE_TYPE.ETH_SIGN_TYPED_DATA_V4},s.isSecurityAlertsEnabledByUser=function(t){const{securityAlertsEnabled:e}=t.state;return e},s.mapChainIdToSupportedEVMChain=c;var n=t("../../../../shared/constants/network"),a=t("../../../../shared/modules/selectors/networks"),i=t("../../../../shared/constants/app"),r=t("./types");const o={[n.CHAIN_IDS.ARBITRUM.toLowerCase()]:r.SupportedEVMChain.Arbitrum,[n.CHAIN_IDS.AVALANCHE.toLowerCase()]:r.SupportedEVMChain.Avalanche,[n.CHAIN_IDS.BASE.toLowerCase()]:r.SupportedEVMChain.Base,[n.CHAIN_IDS.BASE_SEPOLIA.toLowerCase()]:r.SupportedEVMChain.BaseSepolia,[n.CHAIN_IDS.BSC.toLowerCase()]:r.SupportedEVMChain.Bsc,[n.CHAIN_IDS.MAINNET.toLowerCase()]:r.SupportedEVMChain.Ethereum,[n.CHAIN_IDS.OPTIMISM.toLowerCase()]:r.SupportedEVMChain.Optimism,[n.CHAIN_IDS.POLYGON.toLowerCase()]:r.SupportedEVMChain.Polygon,[n.CHAIN_IDS.ZKSYNC_ERA.toLowerCase()]:r.SupportedEVMChain.Zksync,[n.CHAIN_IDS.ZK_SYNC_ERA_TESTNET.toLowerCase()]:r.SupportedEVMChain.ZksyncSepolia,"0x76adf1":r.SupportedEVMChain.Zora,[n.CHAIN_IDS.LINEA_MAINNET.toLowerCase()]:r.SupportedEVMChain.Linea,[n.CHAIN_IDS.BLAST.toLowerCase()]:r.SupportedEVMChain.Blast,[n.CHAIN_IDS.SCROLL.toLowerCase()]:r.SupportedEVMChain.Scroll,[n.CHAIN_IDS.SEPOLIA.toLowerCase()]:r.SupportedEVMChain.EthereumSepolia,"0x27bc86aa":r.SupportedEVMChain.Degen,[n.CHAIN_IDS.AVALANCHE_TESTNET.toLowerCase()]:r.SupportedEVMChain.AvalancheFuji,"0x343b":r.SupportedEVMChain.ImmutableZkevm,"0x34a1":r.SupportedEVMChain.ImmutableZkevmTestnet,[n.CHAIN_IDS.GNOSIS.toLowerCase()]:r.SupportedEVMChain.Gnosis,"0x1e0":r.SupportedEVMChain.Worldchain,"0x79a":r.SupportedEVMChain.SoneiumMinato,"0x7e4":r.SupportedEVMChain.Ronin,[n.CHAIN_IDS.APECHAIN_MAINNET.toLowerCase()]:r.SupportedEVMChain.ApeChain,"0x849ea":r.SupportedEVMChain.ZeroNetwork,[n.CHAIN_IDS.BERACHAIN.toLowerCase()]:r.SupportedEVMChain.Berachain,"0x138c5":r.SupportedEVMChain.BerachainBartio,[n.CHAIN_IDS.INK.toLowerCase()]:r.SupportedEVMChain.Ink,[n.CHAIN_IDS.INK_SEPOLIA.toLowerCase()]:r.SupportedEVMChain.InkSepolia,"0xab5":r.SupportedEVMChain.Abstract,"0x2b74":r.SupportedEVMChain.AbstractTestnet,"0x74c":r.SupportedEVMChain.Soneium,[n.CHAIN_IDS.UNICHAIN.toLowerCase()]:r.SupportedEVMChain.Unichain,[n.CHAIN_IDS.SEI.toLowerCase()]:r.SupportedEVMChain.Sei,[n.CHAIN_IDS.FLOW.toLowerCase()]:r.SupportedEVMChain.FlowEvm};function c(t){return"string"==typeof t&&t?o[t.toLowerCase()]:undefined}}}},{package:"$root$",file:"app/scripts/lib/trust-signals/trust-signals-util.ts"}]],[],{});